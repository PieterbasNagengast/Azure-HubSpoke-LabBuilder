{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.1272.37030",
      "templateHash": "8428198356025764871"
    }
  },
  "parameters": {
    "amountOfSpokes": {
      "type": "int",
      "defaultValue": 2
    },
    "location": {
      "type": "string",
      "defaultValue": "[deployment().location]"
    },
    "startAddressSpace": {
      "type": "string",
      "defaultValue": "172.16."
    },
    "deployBastionInSpoke": {
      "type": "bool",
      "defaultValue": false
    },
    "deployBastionInSHub": {
      "type": "bool",
      "defaultValue": false
    },
    "deployVMsInSpokes": {
      "type": "bool",
      "defaultValue": true
    },
    "deployVMinHub": {
      "type": "bool",
      "defaultValue": false
    },
    "adminUsername": {
      "type": "string"
    },
    "adminPassword": {
      "type": "secureString"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "HubResourceGroup",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "deployBastionInSHub": {
            "value": "[parameters('deployBastionInSHub')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "startAddressSpace": {
            "value": "[parameters('startAddressSpace')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1272.37030",
              "templateHash": "15521565693948636696"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "startAddressSpace": {
              "type": "string"
            },
            "deployBastionInSHub": {
              "type": "bool"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "rg-Hub",
              "location": "[parameters('location')]"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "Hub-VNET",
              "resourceGroup": "rg-Hub",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "vnetname": {
                    "value": "Hub-VNET"
                  },
                  "vnetAddressSpcae": {
                    "value": "[format('{0}0.0/24', parameters('startAddressSpace'))]"
                  },
                  "deployBastionInHub": {
                    "value": "[parameters('deployBastionInSHub')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "15029482499336704961"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "vnetname": {
                      "type": "string"
                    },
                    "vnetAddressSpcae": {
                      "type": "string"
                    },
                    "deployBastionInHub": {
                      "type": "bool"
                    }
                  },
                  "variables": {
                    "defaultSubnetPrefix": "[replace(parameters('vnetAddressSpcae'), '/24', '/25')]",
                    "bastionSubnetPrefix": "[replace(parameters('vnetAddressSpcae'), '0/24', '192/26')]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('vnetname')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('vnetAddressSpcae')]"
                          ]
                        },
                        "subnets": [
                          {
                            "name": "default",
                            "properties": {
                              "addressPrefix": "[variables('defaultSubnetPrefix')]",
                              "networkSecurityGroup": {
                                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-NSG-defaultSubent', parameters('vnetname')))]"
                              },
                              "privateEndpointNetworkPolicies": "Enabled",
                              "privateLinkServiceNetworkPolicies": "Enabled",
                              "delegations": []
                            }
                          },
                          {
                            "name": "AzureBastionSubnet",
                            "properties": {
                              "addressPrefix": "[variables('bastionSubnetPrefix')]",
                              "privateEndpointNetworkPolicies": "Enabled",
                              "privateLinkServiceNetworkPolicies": "Enabled",
                              "delegations": []
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-NSG-defaultSubent', parameters('vnetname')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}-NSG-defaultSubent', parameters('vnetname'))]",
                      "location": "[parameters('location')]"
                    },
                    {
                      "condition": "[parameters('deployBastionInHub')]",
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}-Bastion-Pip', parameters('vnetname'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publicIPAddressVersion": "IPv4",
                        "publicIPAllocationMethod": "Static"
                      },
                      "sku": {
                        "tier": "Regional",
                        "name": "Standard"
                      }
                    },
                    {
                      "condition": "[parameters('deployBastionInHub')]",
                      "type": "Microsoft.Network/bastionHosts",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}-Bastion', parameters('vnetname'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "IpConf",
                            "properties": {
                              "subnet": {
                                "id": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetname'))).subnets[1].id]"
                              },
                              "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-Bastion-Pip', parameters('vnetname')))]"
                              }
                            }
                          }
                        ]
                      },
                      "sku": {
                        "name": "Basic"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-Bastion-Pip', parameters('vnetname')))]",
                        "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetname'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "hubVnetID": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetname'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', 'rg-Hub')]"
              ]
            }
          ],
          "outputs": {
            "hubVnetID": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, 'rg-Hub'), 'Microsoft.Resources/deployments', 'Hub-VNET')).outputs.hubVnetID.value]"
            }
          }
        }
      }
    },
    {
      "copy": {
        "name": "spokeVnets",
        "count": "[length(range(1, parameters('amountOfSpokes')))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('SpokeResourceGroup{0}', range(1, parameters('amountOfSpokes'))[copyIndex()])]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "counter": {
            "value": "[range(1, parameters('amountOfSpokes'))[copyIndex()]]"
          },
          "startAddressSpace": {
            "value": "[parameters('startAddressSpace')]"
          },
          "deployBastionInSpoke": {
            "value": "[parameters('deployBastionInSpoke')]"
          },
          "hubVnetID": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'HubResourceGroup')).outputs.hubVnetID.value]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "deployVMsInSpokes": {
            "value": "[parameters('deployVMsInSpokes')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1272.37030",
              "templateHash": "11736239674290070035"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "startAddressSpace": {
              "type": "string"
            },
            "counter": {
              "type": "int"
            },
            "deployBastionInSpoke": {
              "type": "bool"
            },
            "hubVnetID": {
              "type": "string"
            },
            "adminUsername": {
              "type": "string"
            },
            "adminPassword": {
              "type": "secureString"
            },
            "deployVMsInSpokes": {
              "type": "bool"
            }
          },
          "variables": {
            "hubRgName": "[split(parameters('hubVnetID'), '/')[4]]",
            "hubVnetName": "[split(parameters('hubVnetID'), '/')[8]]",
            "vmName": "[format('VM-Spoke{0}', parameters('counter'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[format('rg-Spoke{0}', parameters('counter'))]",
              "location": "[parameters('location')]"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('Spoke-VNET-{0}', parameters('counter'))]",
              "resourceGroup": "[format('rg-Spoke{0}', parameters('counter'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "vnetname": {
                    "value": "[format('Spoke-VNET-{0}', parameters('counter'))]"
                  },
                  "vnetAddressSpcae": {
                    "value": "[format('{0}{1}.0/24', parameters('startAddressSpace'), parameters('counter'))]"
                  },
                  "deployBastionInSpoke": {
                    "value": "[parameters('deployBastionInSpoke')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "10524179495652724951"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "vnetname": {
                      "type": "string"
                    },
                    "vnetAddressSpcae": {
                      "type": "string"
                    },
                    "deployBastionInSpoke": {
                      "type": "bool"
                    }
                  },
                  "variables": {
                    "defaultSubnetPrefix": "[replace(parameters('vnetAddressSpcae'), '/24', '/25')]",
                    "bastionSubnetPrefix": "[replace(parameters('vnetAddressSpcae'), '0/24', '192/26')]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('vnetname')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('vnetAddressSpcae')]"
                          ]
                        },
                        "subnets": [
                          {
                            "name": "default",
                            "properties": {
                              "addressPrefix": "[variables('defaultSubnetPrefix')]",
                              "networkSecurityGroup": {
                                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-NSG-defaultSubent', parameters('vnetname')))]"
                              },
                              "privateEndpointNetworkPolicies": "Enabled",
                              "privateLinkServiceNetworkPolicies": "Enabled",
                              "delegations": []
                            }
                          },
                          {
                            "name": "AzureBastionSubnet",
                            "properties": {
                              "addressPrefix": "[variables('bastionSubnetPrefix')]",
                              "privateEndpointNetworkPolicies": "Enabled",
                              "privateLinkServiceNetworkPolicies": "Enabled",
                              "delegations": []
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-NSG-defaultSubent', parameters('vnetname')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}-NSG-defaultSubent', parameters('vnetname'))]",
                      "location": "[parameters('location')]"
                    },
                    {
                      "condition": "[parameters('deployBastionInSpoke')]",
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}-Bastion-Pip', parameters('vnetname'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publicIPAddressVersion": "IPv4",
                        "publicIPAllocationMethod": "Static"
                      },
                      "sku": {
                        "tier": "Regional",
                        "name": "Standard"
                      }
                    },
                    {
                      "condition": "[parameters('deployBastionInSpoke')]",
                      "type": "Microsoft.Network/bastionHosts",
                      "apiVersion": "2021-03-01",
                      "name": "[format('{0}-Bastion', parameters('vnetname'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "IpConf",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetname'))).subnets[1].id]"
                              },
                              "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-Bastion-Pip', parameters('vnetname')))]"
                              }
                            }
                          }
                        ]
                      },
                      "sku": {
                        "name": "Basic"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-Bastion-Pip', parameters('vnetname')))]",
                        "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetname'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "defaultSubnetID": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetname'))).subnets[0].id]"
                    },
                    "spokeVnetID": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetname'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-Spoke{0}', parameters('counter')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('peeringTo{0}', variables('hubVnetName'))]",
              "resourceGroup": "[format('rg-Spoke{0}', parameters('counter'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "remoteVnetID": {
                    "value": "[parameters('hubVnetID')]"
                  },
                  "peeringName": {
                    "value": "[format('{0}/peeringTo{1}', format('Spoke-VNET-{0}', parameters('counter')), variables('hubVnetName'))]"
                  },
                  "useRemoteGateways": {
                    "value": false
                  },
                  "allowForwardedTraffic": {
                    "value": true
                  },
                  "allowGatewayTransit": {
                    "value": false
                  },
                  "allowVirtualNetworkAccess": {
                    "value": true
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "7535118577974351196"
                    }
                  },
                  "parameters": {
                    "remoteVnetID": {
                      "type": "string"
                    },
                    "peeringName": {
                      "type": "string"
                    },
                    "allowForwardedTraffic": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "allowGatewayTransit": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "allowVirtualNetworkAccess": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "useRemoteGateways": {
                      "type": "bool",
                      "defaultValue": true
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('peeringName')]",
                      "properties": {
                        "remoteVirtualNetwork": {
                          "id": "[parameters('remoteVnetID')]"
                        },
                        "allowForwardedTraffic": "[parameters('allowForwardedTraffic')]",
                        "allowGatewayTransit": "[parameters('allowGatewayTransit')]",
                        "allowVirtualNetworkAccess": "[parameters('allowVirtualNetworkAccess')]",
                        "useRemoteGateways": "[parameters('useRemoteGateways')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-Spoke{0}', parameters('counter'))), 'Microsoft.Resources/deployments', format('Spoke-VNET-{0}', parameters('counter')))]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-Spoke{0}', parameters('counter')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('peeringTo{0}', format('Spoke-VNET-{0}', parameters('counter')))]",
              "resourceGroup": "[variables('hubRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "remoteVnetID": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-Spoke{0}', parameters('counter'))), 'Microsoft.Resources/deployments', format('Spoke-VNET-{0}', parameters('counter')))).outputs.spokeVnetID.value]"
                  },
                  "peeringName": {
                    "value": "[format('{0}/peeringTo{1}', variables('hubVnetName'), format('Spoke-VNET-{0}', parameters('counter')))]"
                  },
                  "useRemoteGateways": {
                    "value": false
                  },
                  "allowForwardedTraffic": {
                    "value": false
                  },
                  "allowGatewayTransit": {
                    "value": false
                  },
                  "allowVirtualNetworkAccess": {
                    "value": true
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "7535118577974351196"
                    }
                  },
                  "parameters": {
                    "remoteVnetID": {
                      "type": "string"
                    },
                    "peeringName": {
                      "type": "string"
                    },
                    "allowForwardedTraffic": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "allowGatewayTransit": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "allowVirtualNetworkAccess": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "useRemoteGateways": {
                      "type": "bool",
                      "defaultValue": true
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('peeringName')]",
                      "properties": {
                        "remoteVirtualNetwork": {
                          "id": "[parameters('remoteVnetID')]"
                        },
                        "allowForwardedTraffic": "[parameters('allowForwardedTraffic')]",
                        "allowGatewayTransit": "[parameters('allowGatewayTransit')]",
                        "allowVirtualNetworkAccess": "[parameters('allowVirtualNetworkAccess')]",
                        "useRemoteGateways": "[parameters('useRemoteGateways')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-Spoke{0}', parameters('counter'))), 'Microsoft.Resources/deployments', format('Spoke-VNET-{0}', parameters('counter')))]"
              ]
            },
            {
              "condition": "[parameters('deployVMsInSpokes')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('vmName')]",
              "resourceGroup": "[format('rg-Spoke{0}', parameters('counter'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "adminPassword": {
                    "value": "[parameters('adminPassword')]"
                  },
                  "adminUsername": {
                    "value": "[parameters('adminUsername')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "subnetID": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-Spoke{0}', parameters('counter'))), 'Microsoft.Resources/deployments', format('Spoke-VNET-{0}', parameters('counter')))).outputs.defaultSubnetID.value]"
                  },
                  "vmName": {
                    "value": "[variables('vmName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "10221614529340631381"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "vmName": {
                      "type": "string"
                    },
                    "adminUsername": {
                      "type": "string"
                    },
                    "adminPassword": {
                      "type": "secureString"
                    },
                    "subnetID": {
                      "type": "string"
                    },
                    "vmSize": {
                      "type": "string",
                      "defaultValue": "Standard_B2s"
                    },
                    "storageType": {
                      "type": "string",
                      "defaultValue": "StandardSSD_LRS"
                    },
                    "OSVersion": {
                      "type": "string",
                      "defaultValue": "2022-datacenter",
                      "allowedValues": [
                        "2022-datacenter",
                        "2019-datacenter",
                        "2016-datacenter",
                        "2012-R2-datacenter"
                      ]
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2021-11-01",
                      "name": "[parameters('vmName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "osProfile": {
                          "computerName": "[parameters('vmName')]",
                          "adminUsername": "[parameters('adminUsername')]",
                          "adminPassword": "[parameters('adminPassword')]"
                        },
                        "storageProfile": {
                          "imageReference": {
                            "publisher": "MicrosoftWindowsServer",
                            "offer": "WindowsServer",
                            "sku": "[parameters('OSVersion')]",
                            "version": "latest"
                          },
                          "osDisk": {
                            "createOption": "FromImage",
                            "managedDisk": {
                              "storageAccountType": "[parameters('storageType')]"
                            },
                            "osType": "Windows"
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-nic', parameters('vmName')))]"
                            }
                          ]
                        },
                        "hardwareProfile": {
                          "vmSize": "[parameters('vmSize')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-nic', parameters('vmName')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}-nic', parameters('vmName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "ipconfig1",
                            "properties": {
                              "primary": true,
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[parameters('subnetID')]"
                              }
                            }
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-Spoke{0}', parameters('counter'))), 'Microsoft.Resources/deployments', format('Spoke-VNET-{0}', parameters('counter')))]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-Spoke{0}', parameters('counter')))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', 'HubResourceGroup')]"
      ]
    }
  ]
}