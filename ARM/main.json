{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.1272.37030",
      "templateHash": "6445020766052703615"
    }
  },
  "parameters": {
    "hubSubscriptionID": {
      "type": "string",
      "defaultValue": "[subscription().subscriptionId]",
      "metadata": {
        "description": "SubscriptionID for HUB deployemnt"
      }
    },
    "spokeSubscriptionID": {
      "type": "string",
      "defaultValue": "[subscription().subscriptionId]",
      "metadata": {
        "description": "SubscriptionID for Spoke deployemnt"
      }
    },
    "onPremSubscriptionID": {
      "type": "string",
      "defaultValue": "[subscription().subscriptionId]",
      "metadata": {
        "description": "SubscriptionID for OnPrem deployemnt"
      }
    },
    "adminUsername": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Admin username for VM"
      }
    },
    "adminPassword": {
      "type": "secureString",
      "defaultValue": "",
      "metadata": {
        "description": "Admin Password for VM"
      }
    },
    "vmSizeHub": {
      "type": "string",
      "defaultValue": "Standard_B2s",
      "metadata": {
        "description": "Hub Virtual Machine SKU. Default = Standard_B2s"
      }
    },
    "vmSizeSpoke": {
      "type": "string",
      "defaultValue": "Standard_B2s",
      "metadata": {
        "description": "Spoke Virtual Machine SKU. Default = Standard_B2s"
      }
    },
    "vmSizeOnPrem": {
      "type": "string",
      "defaultValue": "Standard_B2s",
      "metadata": {
        "description": "OnPrem Virtual Machine SKU. Default = Standard_B2s"
      }
    },
    "osTypeHub": {
      "type": "string",
      "defaultValue": "Windows",
      "allowedValues": [
        "Linux",
        "Windows"
      ],
      "metadata": {
        "description": "Hub Virtual Machine OS type. Windows or Linux. Default = Windows"
      }
    },
    "osTypeSpoke": {
      "type": "string",
      "defaultValue": "Windows",
      "allowedValues": [
        "Linux",
        "Windows"
      ],
      "metadata": {
        "description": "Spoke Virtual Machine(s) OS type. Windows or Linux. Default = Windows"
      }
    },
    "osTypeOnPrem": {
      "type": "string",
      "defaultValue": "Windows",
      "allowedValues": [
        "Linux",
        "Windows"
      ],
      "metadata": {
        "description": "OnPrem Virtual Machine OS type. Windows or Linux. Default = Windows"
      }
    },
    "AddressSpace": {
      "type": "string",
      "defaultValue": "172.16.0.0/16",
      "metadata": {
        "description": "IP Address space used for VNETs in deployment. Only enter a /16 subnet. Default = 172.16.0.0/16"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[deployment().location]",
      "metadata": {
        "description": "Azure Region. Defualt = Deployment location"
      }
    },
    "tagsByResource": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Tags by resource types"
      }
    },
    "deploySpokes": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy Spoke VNETs"
      }
    },
    "spokeRgNamePrefix": {
      "type": "string",
      "defaultValue": "rg-spoke",
      "metadata": {
        "description": "Spoke resource group prefix name"
      }
    },
    "amountOfSpokes": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "Amount of Spoke VNETs you want to deploy. Default = 2"
      }
    },
    "deployVMsInSpokes": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy VM in every Spoke VNET"
      }
    },
    "deployBastionInSpoke": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Deploy Bastion Host in every Spoke VNET"
      }
    },
    "bastionInSpokeSKU": {
      "type": "string",
      "defaultValue": "Basic",
      "allowedValues": [
        "Basic",
        "Standard"
      ],
      "metadata": {
        "description": "Spoke Bastion SKU"
      }
    },
    "deployHUB": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy Hub"
      }
    },
    "hubType": {
      "type": "string",
      "defaultValue": "VWAN",
      "allowedValues": [
        "VNET",
        "VWAN"
      ],
      "metadata": {
        "description": "Deploy Hub VNET or Azuere vWAN"
      }
    },
    "hubRgName": {
      "type": "string",
      "defaultValue": "rg-hub",
      "metadata": {
        "description": "Hub resource group pre-fix name"
      }
    },
    "deployBastionInHub": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Deploy Bastion Host in Hub VNET"
      }
    },
    "bastionInHubSKU": {
      "type": "string",
      "defaultValue": "Basic",
      "allowedValues": [
        "Basic",
        "Standard"
      ],
      "metadata": {
        "description": "Hub Bastion SKU"
      }
    },
    "deployVMinHub": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Deploy VM in Hub VNET"
      }
    },
    "deployGatewayInHub": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy Virtual Network Gateway in Hub VNET"
      }
    },
    "deployFirewallInHub": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy Azure Firewall in Hub VNET. includes deployment of custom route tables in Spokes and Hub VNETs"
      }
    },
    "AzureFirewallTier": {
      "type": "string",
      "defaultValue": "Standard",
      "allowedValues": [
        "Standard",
        "Premium"
      ],
      "metadata": {
        "description": "Azure Firewall Tier: Standard or Premium"
      }
    },
    "deployFirewallrules": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy Firewall policy Rule Collection group which allows spoke-to-spoke and internet traffic"
      }
    },
    "deployUDRs": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Dploy route tables (UDR's) to VM subnet(s) in Hub and Spokes"
      }
    },
    "hubBgp": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable BGP on Hub Gateway"
      }
    },
    "hubBgpAsn": {
      "type": "int",
      "defaultValue": 65515,
      "metadata": {
        "description": "Hub BGP ASN"
      }
    },
    "deployOnPrem": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy Virtual Network Gateway in OnPrem"
      }
    },
    "onpremRgName": {
      "type": "string",
      "defaultValue": "rg-onprem",
      "metadata": {
        "description": "OnPrem Resource Group Name"
      }
    },
    "deployBastionInOnPrem": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy Bastion Host in OnPrem VNET"
      }
    },
    "bastionInOnPremSKU": {
      "type": "string",
      "defaultValue": "Basic",
      "allowedValues": [
        "Basic",
        "Standard"
      ],
      "metadata": {
        "description": "OnPrem Bastion SKU"
      }
    },
    "deployVMinOnPrem": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy VM in OnPrem VNET"
      }
    },
    "deployGatewayinOnPrem": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy Virtual Network Gateway in OnPrem VNET"
      }
    },
    "deploySiteToSite": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy Site-to-Site VPN connection between OnPrem and Hub Gateways"
      }
    },
    "sharedKey": {
      "type": "secureString",
      "defaultValue": "",
      "metadata": {
        "description": "Site-to-Site ShareKey"
      }
    },
    "onpremBgp": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable BGP on OnPrem Gateway"
      }
    },
    "onpremBgpAsn": {
      "type": "int",
      "defaultValue": 65020,
      "metadata": {
        "description": "OnPrem BGP ASN"
      }
    }
  },
  "variables": {
    "copy": [
      {
        "name": "AllAddressSpaces",
        "count": "[length(range(0, add(parameters('amountOfSpokes'), 1)))]",
        "input": "[replace(parameters('AddressSpace'), '0.0/16', format('{0}.0/24', range(0, add(parameters('amountOfSpokes'), 1))[copyIndex('AllAddressSpaces')]))]"
      },
      {
        "name": "AllSpokeAddressSpaces",
        "count": "[length(range(1, parameters('amountOfSpokes')))]",
        "input": "[replace(parameters('AddressSpace'), '0.0/16', format('{0}.0/24', range(1, parameters('amountOfSpokes'))[copyIndex('AllSpokeAddressSpaces')]))]"
      }
    ]
  },
  "resources": [
    {
      "condition": "[and(parameters('deployHUB'), equals(parameters('hubType'), 'VNET'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-{1}-VNET', parameters('hubRgName'), parameters('location'))]",
      "subscriptionId": "[parameters('hubSubscriptionID')]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "deployBastionInHub": {
            "value": "[and(parameters('deployBastionInHub'), equals(parameters('hubType'), 'VNET'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "AddressSpace": {
            "value": "[parameters('AddressSpace')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "deployVMinHub": {
            "value": "[and(parameters('deployVMinHub'), equals(parameters('hubType'), 'VNET'))]"
          },
          "deployFirewallInHub": {
            "value": "[and(parameters('deployFirewallInHub'), equals(parameters('hubType'), 'VNET'))]"
          },
          "AzureFirewallTier": {
            "value": "[parameters('AzureFirewallTier')]"
          },
          "hubRgName": {
            "value": "[parameters('hubRgName')]"
          },
          "deployFirewallrules": {
            "value": "[and(parameters('deployFirewallrules'), equals(parameters('hubType'), 'VNET'))]"
          },
          "deployGatewayInHub": {
            "value": "[and(parameters('deployGatewayInHub'), equals(parameters('hubType'), 'VNET'))]"
          },
          "vmSize": {
            "value": "[parameters('vmSizeHub')]"
          },
          "tagsByResource": {
            "value": "[parameters('tagsByResource')]"
          },
          "osType": {
            "value": "[parameters('osTypeHub')]"
          },
          "AllSpokeAddressSpaces": {
            "value": "[variables('AllSpokeAddressSpaces')]"
          },
          "vpnGwBgpAsn": {
            "value": "[if(parameters('hubBgp'), parameters('hubBgpAsn'), 65515)]"
          },
          "vpnGwEnebaleBgp": {
            "value": "[parameters('hubBgp')]"
          },
          "deployUDRs": {
            "value": "[parameters('deployUDRs')]"
          },
          "bastionSku": {
            "value": "[parameters('bastionInHubSKU')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1272.37030",
              "templateHash": "15554627215506730145"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "AddressSpace": {
              "type": "string"
            },
            "deployBastionInHub": {
              "type": "bool"
            },
            "bastionSku": {
              "type": "string"
            },
            "adminUsername": {
              "type": "string"
            },
            "adminPassword": {
              "type": "secureString"
            },
            "deployVMinHub": {
              "type": "bool"
            },
            "deployFirewallInHub": {
              "type": "bool"
            },
            "AzureFirewallTier": {
              "type": "string"
            },
            "hubRgName": {
              "type": "string"
            },
            "deployFirewallrules": {
              "type": "bool"
            },
            "deployUDRs": {
              "type": "bool"
            },
            "deployGatewayInHub": {
              "type": "bool"
            },
            "vmSize": {
              "type": "string"
            },
            "tagsByResource": {
              "type": "object"
            },
            "osType": {
              "type": "string"
            },
            "AllSpokeAddressSpaces": {
              "type": "array"
            },
            "vpnGwEnebaleBgp": {
              "type": "bool"
            },
            "vpnGwBgpAsn": {
              "type": "int"
            }
          },
          "variables": {
            "vnetAddressSpace": "[replace(parameters('AddressSpace'), '/16', '/24')]",
            "defaultSubnetPrefix": "[replace(variables('vnetAddressSpace'), '/24', '/26')]",
            "firewallSubnetPrefix": "[replace(variables('vnetAddressSpace'), '0/24', '64/26')]",
            "bastionSubnetPrefix": "[replace(variables('vnetAddressSpace'), '0/24', '128/27')]",
            "gatewaySubnetPrefix": "[replace(variables('vnetAddressSpace'), '0/24', '160/27')]",
            "vmName": "VM-Hub",
            "nsgName": "NSG-Hub",
            "bastionName": "Bastion-Hub",
            "rtNameDefSubnet": "RT-Hub-DefaultSubnet",
            "rtNameVPNgwSubnet": "RT-Hub-GatewaySubnet",
            "hubVnetName": "VNET-Hub",
            "firewallName": "Firewall-Hub",
            "gatewayName": "Gateway-Hub"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[parameters('hubRgName')]",
              "location": "[parameters('location')]",
              "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Resources/subscriptions/resourceGroups'), parameters('tagsByResource')['Microsoft.Resources/subscriptions/resourceGroups'], createObject())]"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "hubvnet",
              "resourceGroup": "[parameters('hubRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "vnetAddressSpcae": {
                    "value": "[variables('vnetAddressSpace')]"
                  },
                  "nsgID": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'nsg')).outputs.nsgID.value]"
                  },
                  "rtDefID": {
                    "value": "[if(and(parameters('deployFirewallInHub'), parameters('deployUDRs')), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'routeTable-Default')).outputs.rtID.value, 'none')]"
                  },
                  "rtGwID": {
                    "value": "[if(and(parameters('deployFirewallInHub'), parameters('deployGatewayInHub')), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'routeTable-VPNGW')).outputs.rtID.value, 'none')]"
                  },
                  "vnetname": {
                    "value": "[variables('hubVnetName')]"
                  },
                  "defaultSubnetPrefix": {
                    "value": "[variables('defaultSubnetPrefix')]"
                  },
                  "bastionSubnetPrefix": {
                    "value": "[variables('bastionSubnetPrefix')]"
                  },
                  "firewallSubnetPrefix": {
                    "value": "[variables('firewallSubnetPrefix')]"
                  },
                  "GatewaySubnetPrefix": {
                    "value": "[variables('gatewaySubnetPrefix')]"
                  },
                  "deployBastionSubnet": {
                    "value": "[parameters('deployBastionInHub')]"
                  },
                  "deployFirewallSubnet": {
                    "value": "[parameters('deployFirewallInHub')]"
                  },
                  "deployGatewaySubnet": {
                    "value": "[parameters('deployGatewayInHub')]"
                  },
                  "tagsByResource": {
                    "value": "[parameters('tagsByResource')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "15972562488758076476"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "vnetname": {
                      "type": "string"
                    },
                    "vnetAddressSpcae": {
                      "type": "string"
                    },
                    "defaultSubnetPrefix": {
                      "type": "string"
                    },
                    "bastionSubnetPrefix": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "firewallSubnetPrefix": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "GatewaySubnetPrefix": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "nsgID": {
                      "type": "string"
                    },
                    "rtDefID": {
                      "type": "string",
                      "defaultValue": "none"
                    },
                    "rtGwID": {
                      "type": "string",
                      "defaultValue": "none"
                    },
                    "deployBastionSubnet": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "deployFirewallSubnet": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "deployGatewaySubnet": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "variables": {
                    "defaultSubnet": [
                      {
                        "name": "default",
                        "properties": {
                          "addressPrefix": "[parameters('defaultSubnetPrefix')]",
                          "networkSecurityGroup": {
                            "id": "[parameters('nsgID')]"
                          },
                          "routeTable": "[if(equals(parameters('rtDefID'), 'none'), json('null'), json(format('{{\"id\": \"{0}\"}}\"', parameters('rtDefID'))))]"
                        }
                      }
                    ],
                    "bastionSubnet": "[if(not(parameters('deployBastionSubnet')), createArray(), createArray(createObject('name', 'AzureBastionSubnet', 'properties', createObject('addressPrefix', parameters('bastionSubnetPrefix')))))]",
                    "firewallSubnet": "[if(not(parameters('deployFirewallSubnet')), createArray(), createArray(createObject('name', 'AzureFirewallSubnet', 'properties', createObject('addressPrefix', parameters('firewallSubnetPrefix')))))]",
                    "gatewaySubnet": "[if(and(not(parameters('deployGatewaySubnet')), not(parameters('deployFirewallSubnet'))), createArray(), createArray(createObject('name', 'GatewaySubnet', 'properties', createObject('addressPrefix', parameters('GatewaySubnetPrefix'), 'routeTable', if(equals(parameters('rtGwID'), 'none'), json('null'), json(format('{{\"id\": \"{0}\"}}\"', parameters('rtGwID'))))))))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('vnetname')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('vnetAddressSpcae')]"
                          ]
                        },
                        "subnets": "[concat(variables('defaultSubnet'), variables('bastionSubnet'), variables('firewallSubnet'), variables('gatewaySubnet'))]"
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/virtualNetworks'), parameters('tagsByResource')['Microsoft.Network/virtualNetworks'], createObject())]"
                    }
                  ],
                  "outputs": {
                    "vnetName": {
                      "type": "string",
                      "value": "[parameters('vnetname')]"
                    },
                    "vnetID": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetname'))]"
                    },
                    "defaultSubnetID": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetname'))).subnets[0].id]"
                    },
                    "bastionSubnetID": {
                      "type": "string",
                      "value": "[if(parameters('deployBastionSubnet'), resourceId('Microsoft.Network/VirtualNetworks/subnets', parameters('vnetname'), 'AzureBastionSubnet'), 'Not deployed')]"
                    },
                    "firewallSubnetID": {
                      "type": "string",
                      "value": "[if(parameters('deployFirewallSubnet'), resourceId('Microsoft.Network/VirtualNetworks/subnets', parameters('vnetname'), 'AzureFirewallSubnet'), 'Not deployed')]"
                    },
                    "gatewaySubnetID": {
                      "type": "string",
                      "value": "[if(parameters('deployGatewaySubnet'), resourceId('Microsoft.Network/VirtualNetworks/subnets', parameters('vnetname'), 'GatewaySubnet'), 'Not deployed')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('hubRgName'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'nsg')]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'routeTable-Default')]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'routeTable-VPNGW')]"
              ]
            },
            {
              "condition": "[parameters('deployVMinHub')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "virtualMachine",
              "resourceGroup": "[parameters('hubRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "adminPassword": {
                    "value": "[parameters('adminPassword')]"
                  },
                  "adminUsername": {
                    "value": "[parameters('adminUsername')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "subnetID": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'hubvnet')).outputs.defaultSubnetID.value]"
                  },
                  "vmName": {
                    "value": "[variables('vmName')]"
                  },
                  "vmSize": {
                    "value": "[parameters('vmSize')]"
                  },
                  "tagsByResource": {
                    "value": "[parameters('tagsByResource')]"
                  },
                  "osType": {
                    "value": "[parameters('osType')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "8734156456072154768"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "vmName": {
                      "type": "string"
                    },
                    "adminUsername": {
                      "type": "string"
                    },
                    "adminPassword": {
                      "type": "secureString"
                    },
                    "subnetID": {
                      "type": "string"
                    },
                    "vmSize": {
                      "type": "string"
                    },
                    "storageType": {
                      "type": "string",
                      "defaultValue": "StandardSSD_LRS"
                    },
                    "osType": {
                      "type": "string",
                      "defaultValue": "Windows"
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "variables": {
                    "EnableICMPv4": "netsh advfirewall firewall add rule name=\"ICMP Allow incoming V4 echo request\" protocol=\"icmpv4:8,any\" dir=in action=allow",
                    "Windows": {
                      "publisher": "MicrosoftWindowsServer",
                      "offer": "WindowsServer",
                      "sku": "2022-datacenter-g2",
                      "version": "latest"
                    },
                    "Linux": {
                      "publisher": "Canonical",
                      "offer": "0001-com-ubuntu-server-jammy",
                      "sku": "22_04-lts-gen2",
                      "version": "latest"
                    },
                    "imagereference": "[if(equals(parameters('osType'), 'Windows'), variables('Windows'), if(equals(parameters('osType'), 'Linux'), variables('Linux'), createObject()))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2021-11-01",
                      "name": "[parameters('vmName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "osProfile": {
                          "computerName": "[parameters('vmName')]",
                          "adminUsername": "[parameters('adminUsername')]",
                          "adminPassword": "[parameters('adminPassword')]"
                        },
                        "storageProfile": {
                          "imageReference": "[variables('imagereference')]",
                          "osDisk": {
                            "createOption": "FromImage",
                            "managedDisk": {
                              "storageAccountType": "[parameters('storageType')]"
                            },
                            "osType": "[parameters('osType')]",
                            "deleteOption": "Delete"
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-nic', parameters('vmName')))]",
                              "properties": {
                                "deleteOption": "Delete"
                              }
                            }
                          ]
                        },
                        "hardwareProfile": {
                          "vmSize": "[parameters('vmSize')]"
                        },
                        "diagnosticsProfile": {
                          "bootDiagnostics": {
                            "enabled": true
                          }
                        }
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Compute/virtualMachines'), parameters('tagsByResource')['Microsoft.Compute/virtualMachines'], createObject())]",
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-nic', parameters('vmName')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}-nic', parameters('vmName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "ipconfig1",
                            "properties": {
                              "primary": true,
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[parameters('subnetID')]"
                              }
                            }
                          }
                        ]
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Compute/virtualMachines'), parameters('tagsByResource')['Microsoft.Compute/virtualMachines'], createObject())]"
                    },
                    {
                      "condition": "[equals(parameters('osType'), 'Windows')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[format('{0}-runCommand', parameters('vmName'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "runCommand": {
                            "value": "[variables('EnableICMPv4')]"
                          },
                          "vmName": {
                            "value": "[parameters('vmName')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.1272.37030",
                              "templateHash": "13065007741233957351"
                            }
                          },
                          "parameters": {
                            "location": {
                              "type": "string"
                            },
                            "vmName": {
                              "type": "string"
                            },
                            "runName": {
                              "type": "string",
                              "defaultValue": "RunCommand"
                            },
                            "runCommand": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Compute/virtualMachines/runCommands",
                              "apiVersion": "2021-11-01",
                              "name": "[format('{0}/{1}', parameters('vmName'), parameters('runName'))]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "source": {
                                  "script": "[parameters('runCommand')]"
                                },
                                "timeoutInSeconds": 60
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('hubRgName'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'hubvnet')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "nsg",
              "resourceGroup": "[parameters('hubRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "nsgName": {
                    "value": "[variables('nsgName')]"
                  },
                  "tagsByResource": {
                    "value": "[parameters('tagsByResource')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "4986852817278939313"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "nsgName": {
                      "type": "string"
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('nsgName')]",
                      "location": "[parameters('location')]",
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/networkSecurityGroups'), parameters('tagsByResource')['Microsoft.Network/networkSecurityGroups'], createObject())]"
                    }
                  ],
                  "outputs": {
                    "nsgID": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('hubRgName'))]"
              ]
            },
            {
              "condition": "[parameters('deployBastionInHub')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "bastion",
              "resourceGroup": "[parameters('hubRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "subnetID": {
                    "value": "[if(parameters('deployBastionInHub'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'hubvnet')).outputs.bastionSubnetID.value, '')]"
                  },
                  "bastionName": {
                    "value": "[variables('bastionName')]"
                  },
                  "tagsByResource": {
                    "value": "[parameters('tagsByResource')]"
                  },
                  "bastionSku": {
                    "value": "[parameters('bastionSku')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "5886547612277966671"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "bastionName": {
                      "type": "string"
                    },
                    "subnetID": {
                      "type": "string"
                    },
                    "bastionSku": {
                      "type": "string",
                      "allowedValues": [
                        "Basic",
                        "Standard"
                      ]
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/bastionHosts",
                      "apiVersion": "2021-03-01",
                      "name": "[parameters('bastionName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "IpConf",
                            "properties": {
                              "subnet": {
                                "id": "[parameters('subnetID')]"
                              },
                              "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-pip', parameters('bastionName')))]"
                              }
                            }
                          }
                        ]
                      },
                      "sku": {
                        "name": "[parameters('bastionSku')]"
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/bastionHosts'), parameters('tagsByResource')['Microsoft.Network/bastionHosts'], createObject())]",
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-pip', parameters('bastionName')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}-pip', parameters('bastionName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publicIPAddressVersion": "IPv4",
                        "publicIPAllocationMethod": "Static"
                      },
                      "sku": {
                        "tier": "Regional",
                        "name": "Standard"
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/publicIPAddresses'), parameters('tagsByResource')['Microsoft.Network/publicIPAddresses'], createObject())]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('hubRgName'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'hubvnet')]"
              ]
            },
            {
              "condition": "[parameters('deployFirewallInHub')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "hubFirewall",
              "resourceGroup": "[parameters('hubRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "deployInVWan": {
                    "value": false
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "firewallName": {
                    "value": "[variables('firewallName')]"
                  },
                  "azfwsubnetid": {
                    "value": "[if(parameters('deployFirewallInHub'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'hubvnet')).outputs.firewallSubnetID.value, '')]"
                  },
                  "azfwTier": {
                    "value": "[parameters('AzureFirewallTier')]"
                  },
                  "tagsByResource": {
                    "value": "[parameters('tagsByResource')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "16460631289536220742"
                    }
                  },
                  "parameters": {
                    "firewallName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "azfwTier": {
                      "type": "string",
                      "allowedValues": [
                        "Standard",
                        "Premium"
                      ]
                    },
                    "azfwsubnetid": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "vWanID": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "vWanAzFwPublicIPcount": {
                      "type": "int",
                      "defaultValue": 1
                    },
                    "deployInVWan": {
                      "type": "bool",
                      "defaultValue": false
                    }
                  },
                  "variables": {
                    "azfwSKUname": "[if(parameters('deployInVWan'), 'AZFW_Hub', 'AZFW_VNet')]",
                    "pipName": "[format('{0}-pip', parameters('firewallName'))]",
                    "firewallPolicyName": "[format('{0}-policy', parameters('firewallName'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/azureFirewalls",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('firewallName')]",
                      "location": "[parameters('location')]",
                      "zones": [],
                      "properties": {
                        "sku": {
                          "name": "[variables('azfwSKUname')]",
                          "tier": "[parameters('azfwTier')]"
                        },
                        "firewallPolicy": {
                          "id": "[resourceId('Microsoft.Network/firewallPolicies', variables('firewallPolicyName'))]"
                        },
                        "ipConfigurations": "[if(parameters('deployInVWan'), null(), createArray(createObject('properties', createObject('publicIPAddress', createObject('id', resourceId('Microsoft.Network/publicIPAddresses', variables('pipName'))), 'subnet', createObject('id', parameters('azfwsubnetid'))), 'name', 'ipconfig1')))]",
                        "virtualHub": "[if(parameters('deployInVWan'), createObject('id', parameters('vWanID')), null())]",
                        "hubIPAddresses": "[if(parameters('deployInVWan'), createObject('publicIPs', createObject('count', parameters('vWanAzFwPublicIPcount'))), null())]"
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/azureFirewalls'), parameters('tagsByResource')['Microsoft.Network/azureFirewalls'], createObject())]",
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', variables('pipName'))]",
                        "[resourceId('Microsoft.Network/firewallPolicies', variables('firewallPolicyName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/firewallPolicies",
                      "apiVersion": "2021-05-01",
                      "name": "[variables('firewallPolicyName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "sku": {
                          "tier": "[parameters('azfwTier')]"
                        },
                        "threatIntelMode": "Alert"
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/firewallPolicies'), parameters('tagsByResource')['Microsoft.Network/firewallPolicies'], createObject())]"
                    },
                    {
                      "condition": "[not(parameters('deployInVWan'))]",
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2021-05-01",
                      "name": "[variables('pipName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publicIPAddressVersion": "IPv4",
                        "publicIPAllocationMethod": "Static"
                      },
                      "sku": {
                        "tier": "Regional",
                        "name": "Standard"
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/publicIPAddresses'), parameters('tagsByResource')['Microsoft.Network/publicIPAddresses'], createObject())]"
                    }
                  ],
                  "outputs": {
                    "azFwIP": {
                      "type": "string",
                      "value": "[if(parameters('deployInVWan'), 'None', reference(resourceId('Microsoft.Network/azureFirewalls', parameters('firewallName'))).ipConfigurations[0].properties.privateIPAddress)]"
                    },
                    "azFwIPvWan": {
                      "type": "array",
                      "value": "[if(parameters('deployInVWan'), reference(resourceId('Microsoft.Network/azureFirewalls', parameters('firewallName'))).hubIPAddresses.publicIPs.addresses, createArray())]"
                    },
                    "azFwID": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/azureFirewalls', parameters('firewallName'))]"
                    },
                    "azFwPolicyName": {
                      "type": "string",
                      "value": "[variables('firewallPolicyName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('hubRgName'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'hubvnet')]"
              ]
            },
            {
              "condition": "[and(parameters('deployFirewallrules'), parameters('deployFirewallInHub'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "firewallRules",
              "resourceGroup": "[parameters('hubRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "azFwPolicyName": {
                    "value": "[if(and(parameters('deployFirewallInHub'), parameters('deployFirewallrules')), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'hubFirewall')).outputs.azFwPolicyName.value, '')]"
                  },
                  "AddressSpace": {
                    "value": "[parameters('AddressSpace')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "2163297474746570044"
                    }
                  },
                  "parameters": {
                    "azFwPolicyName": {
                      "type": "string"
                    },
                    "ruleCollectiongroupName": {
                      "type": "string",
                      "defaultValue": "HubSpokeLabBuilderCollectionGroup"
                    },
                    "AddressSpace": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/firewallPolicies/ruleCollectionGroups",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}/{1}', parameters('azFwPolicyName'), parameters('ruleCollectiongroupName'))]",
                      "properties": {
                        "priority": 400,
                        "ruleCollections": [
                          {
                            "name": "NetworkRules",
                            "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                            "action": {
                              "type": "Allow"
                            },
                            "priority": 100,
                            "rules": [
                              {
                                "name": "AllowLocalTraffic",
                                "ruleType": "NetworkRule",
                                "sourceAddresses": [
                                  "[parameters('AddressSpace')]"
                                ],
                                "destinationAddresses": [
                                  "[parameters('AddressSpace')]"
                                ],
                                "ipProtocols": [
                                  "Any"
                                ],
                                "destinationPorts": [
                                  "*"
                                ]
                              }
                            ]
                          },
                          {
                            "name": "ApplicationRules",
                            "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                            "action": {
                              "type": "Allow"
                            },
                            "priority": 200,
                            "rules": [
                              {
                                "name": "AllowHttpHttps",
                                "ruleType": "ApplicationRule",
                                "sourceAddresses": [
                                  "[parameters('AddressSpace')]"
                                ],
                                "sourceIpGroups": [],
                                "destinationAddresses": [],
                                "terminateTLS": false,
                                "fqdnTags": [],
                                "webCategories": [],
                                "targetUrls": [],
                                "targetFqdns": [
                                  "*"
                                ],
                                "protocols": [
                                  {
                                    "protocolType": "Http",
                                    "port": 80
                                  },
                                  {
                                    "protocolType": "Https",
                                    "port": 443
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'hubFirewall')]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('hubRgName'))]"
              ]
            },
            {
              "condition": "[and(parameters('deployFirewallInHub'), parameters('deployUDRs'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "routeTable-Default",
              "resourceGroup": "[parameters('hubRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "rtName": {
                    "value": "[variables('rtNameDefSubnet')]"
                  },
                  "tagsByResource": {
                    "value": "[parameters('tagsByResource')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "7736955651557094540"
                    }
                  },
                  "parameters": {
                    "rtName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "disableRouteProp": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/routeTables",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('rtName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "disableBgpRoutePropagation": "[parameters('disableRouteProp')]"
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/routeTables'), parameters('tagsByResource')['Microsoft.Network/routeTables'], createObject())]"
                    }
                  ],
                  "outputs": {
                    "rtID": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/routeTables', parameters('rtName'))]"
                    },
                    "rtName": {
                      "type": "string",
                      "value": "[parameters('rtName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('hubRgName'))]"
              ]
            },
            {
              "condition": "[and(parameters('deployFirewallInHub'), parameters('deployUDRs'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "RouteToInternet",
              "resourceGroup": "[parameters('hubRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "routeAddressPrefix": {
                    "value": "0.0.0.0/0"
                  },
                  "routeName": {
                    "value": "[if(and(parameters('deployFirewallInHub'), parameters('deployUDRs')), format('{0}/toInternet', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'routeTable-Default')).outputs.rtName.value), 'dummy1')]"
                  },
                  "routeNextHopIpAddress": {
                    "value": "[if(and(parameters('deployFirewallInHub'), parameters('deployUDRs')), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'hubFirewall')).outputs.azFwIP.value, '1.2.3.4')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "8096143721828499520"
                    }
                  },
                  "parameters": {
                    "routeName": {
                      "type": "string"
                    },
                    "routeNextHopType": {
                      "type": "string",
                      "defaultValue": "VirtualAppliance"
                    },
                    "routeAddressPrefix": {
                      "type": "string"
                    },
                    "routeNextHopIpAddress": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/routeTables/routes",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('routeName')]",
                      "properties": {
                        "nextHopType": "[parameters('routeNextHopType')]",
                        "addressPrefix": "[parameters('routeAddressPrefix')]",
                        "nextHopIpAddress": "[parameters('routeNextHopIpAddress')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'hubFirewall')]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('hubRgName'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'routeTable-Default')]"
              ]
            },
            {
              "condition": "[and(parameters('deployFirewallInHub'), parameters('deployUDRs'))]",
              "copy": {
                "name": "routeDefault2",
                "count": "[length(parameters('AllSpokeAddressSpaces'))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('RouteToLocal{0}', copyIndex())]",
              "resourceGroup": "[parameters('hubRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "routeAddressPrefix": {
                    "value": "[parameters('AllSpokeAddressSpaces')[copyIndex()]]"
                  },
                  "routeName": {
                    "value": "[if(and(parameters('deployFirewallInHub'), parameters('deployUDRs')), format('{0}/LocalRoute{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'routeTable-Default')).outputs.rtName.value, copyIndex()), 'dummy2')]"
                  },
                  "routeNextHopIpAddress": {
                    "value": "[if(and(parameters('deployFirewallInHub'), parameters('deployUDRs')), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'hubFirewall')).outputs.azFwIP.value, '1.2.3.4')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "8096143721828499520"
                    }
                  },
                  "parameters": {
                    "routeName": {
                      "type": "string"
                    },
                    "routeNextHopType": {
                      "type": "string",
                      "defaultValue": "VirtualAppliance"
                    },
                    "routeAddressPrefix": {
                      "type": "string"
                    },
                    "routeNextHopIpAddress": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/routeTables/routes",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('routeName')]",
                      "properties": {
                        "nextHopType": "[parameters('routeNextHopType')]",
                        "addressPrefix": "[parameters('routeAddressPrefix')]",
                        "nextHopIpAddress": "[parameters('routeNextHopIpAddress')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'hubFirewall')]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('hubRgName'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'routeTable-Default')]"
              ]
            },
            {
              "condition": "[parameters('deployGatewayInHub')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('gatewayName')]",
              "resourceGroup": "[parameters('hubRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "vpnGatewayName": {
                    "value": "[variables('gatewayName')]"
                  },
                  "vpnGatewaySubnetID": {
                    "value": "[if(parameters('deployGatewayInHub'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'hubvnet')).outputs.gatewaySubnetID.value, '')]"
                  },
                  "tagsByResource": {
                    "value": "[parameters('tagsByResource')]"
                  },
                  "vpnGatewayBgpAsn": {
                    "value": "[if(parameters('vpnGwEnebaleBgp'), parameters('vpnGwBgpAsn'), 65515)]"
                  },
                  "vpnGatewayEnableBgp": {
                    "value": "[parameters('vpnGwEnebaleBgp')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "13332477170440770040"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "vpnGatewayName": {
                      "type": "string"
                    },
                    "vpnGatewaySubnetID": {
                      "type": "string"
                    },
                    "vpnGatewaySKU": {
                      "type": "string",
                      "defaultValue": "VpnGw1"
                    },
                    "vpnGatewayType": {
                      "type": "string",
                      "defaultValue": "Vpn"
                    },
                    "vpnGatewayVPNtype": {
                      "type": "string",
                      "defaultValue": "RouteBased"
                    },
                    "vpnGatewayGen": {
                      "type": "string",
                      "defaultValue": "Generation1"
                    },
                    "vpnGatewayEnableBgp": {
                      "type": "bool"
                    },
                    "vpnGatewayBgpAsn": {
                      "type": "int"
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "variables": {
                    "pipName": "[format('{0}-pip', parameters('vpnGatewayName'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworkGateways",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('vpnGatewayName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "gatewayType": "[parameters('vpnGatewayType')]",
                        "vpnType": "[parameters('vpnGatewayVPNtype')]",
                        "enableBgp": "[parameters('vpnGatewayEnableBgp')]",
                        "bgpSettings": {
                          "asn": "[parameters('vpnGatewayBgpAsn')]"
                        },
                        "sku": {
                          "name": "[parameters('vpnGatewaySKU')]",
                          "tier": "[parameters('vpnGatewaySKU')]"
                        },
                        "vpnGatewayGeneration": "[parameters('vpnGatewayGen')]",
                        "activeActive": false,
                        "ipConfigurations": [
                          {
                            "name": "ipConfig",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[parameters('vpnGatewaySubnetID')]"
                              },
                              "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('pipName'))]"
                              }
                            }
                          }
                        ]
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/virtualNetworkGateways'), parameters('tagsByResource')['Microsoft.Network/virtualNetworkGateways'], createObject())]",
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', variables('pipName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2021-05-01",
                      "name": "[variables('pipName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publicIPAddressVersion": "IPv4",
                        "publicIPAllocationMethod": "Static"
                      },
                      "sku": {
                        "tier": "Regional",
                        "name": "Standard"
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/publicIPAddresses'), parameters('tagsByResource')['Microsoft.Network/publicIPAddresses'], createObject())]"
                    }
                  ],
                  "outputs": {
                    "vpnGwPublicIP": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('pipName'))).ipAddress]"
                    },
                    "vpnGwID": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworkGateways', parameters('vpnGatewayName'))]"
                    },
                    "vpnGwBgpPeeringAddress": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Network/virtualNetworkGateways', parameters('vpnGatewayName'))).bgpSettings.bgpPeeringAddress]"
                    },
                    "vpnGwName": {
                      "type": "string",
                      "value": "[parameters('vpnGatewayName')]"
                    },
                    "vpnGwAsn": {
                      "type": "int",
                      "value": "[reference(resourceId('Microsoft.Network/virtualNetworkGateways', parameters('vpnGatewayName'))).bgpSettings.asn]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('hubRgName'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'hubvnet')]"
              ]
            },
            {
              "condition": "[and(and(parameters('deployFirewallInHub'), parameters('deployGatewayInHub')), parameters('deployUDRs'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "routeTable-VPNGW",
              "resourceGroup": "[parameters('hubRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "rtName": {
                    "value": "[variables('rtNameVPNgwSubnet')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "7736955651557094540"
                    }
                  },
                  "parameters": {
                    "rtName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "disableRouteProp": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/routeTables",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('rtName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "disableBgpRoutePropagation": "[parameters('disableRouteProp')]"
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/routeTables'), parameters('tagsByResource')['Microsoft.Network/routeTables'], createObject())]"
                    }
                  ],
                  "outputs": {
                    "rtID": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/routeTables', parameters('rtName'))]"
                    },
                    "rtName": {
                      "type": "string",
                      "value": "[parameters('rtName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('hubRgName'))]"
              ]
            },
            {
              "condition": "[and(and(parameters('deployFirewallInHub'), parameters('deployGatewayInHub')), parameters('deployUDRs'))]",
              "copy": {
                "name": "routeVPNgw",
                "count": "[length(concat(parameters('AllSpokeAddressSpaces'), array(variables('defaultSubnetPrefix'))))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('Route-vpngw{0}', copyIndex())]",
              "resourceGroup": "[parameters('hubRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "routeAddressPrefix": {
                    "value": "[concat(parameters('AllSpokeAddressSpaces'), array(variables('defaultSubnetPrefix')))[copyIndex()]]"
                  },
                  "routeName": {
                    "value": "[if(and(and(parameters('deployFirewallInHub'), parameters('deployGatewayInHub')), parameters('deployUDRs')), format('{0}/LocalRoute{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'routeTable-VPNGW')).outputs.rtName.value, copyIndex()), 'dummy3')]"
                  },
                  "routeNextHopIpAddress": {
                    "value": "[if(and(parameters('deployFirewallInHub'), parameters('deployUDRs')), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'hubFirewall')).outputs.azFwIP.value, '1.2.3.4')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "8096143721828499520"
                    }
                  },
                  "parameters": {
                    "routeName": {
                      "type": "string"
                    },
                    "routeNextHopType": {
                      "type": "string",
                      "defaultValue": "VirtualAppliance"
                    },
                    "routeAddressPrefix": {
                      "type": "string"
                    },
                    "routeNextHopIpAddress": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/routeTables/routes",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('routeName')]",
                      "properties": {
                        "nextHopType": "[parameters('routeNextHopType')]",
                        "addressPrefix": "[parameters('routeAddressPrefix')]",
                        "nextHopIpAddress": "[parameters('routeNextHopIpAddress')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'hubFirewall')]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('hubRgName'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'routeTable-VPNGW')]"
              ]
            }
          ],
          "outputs": {
            "hubVnetID": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'hubvnet')).outputs.vnetID.value]"
            },
            "azFwIp": {
              "type": "string",
              "value": "[if(parameters('deployFirewallInHub'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'hubFirewall')).outputs.azFwIP.value, '1.2.3.4')]"
            },
            "HubResourceGroupName": {
              "type": "string",
              "value": "[parameters('hubRgName')]"
            },
            "hubVnetName": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', 'hubvnet')).outputs.vnetName.value]"
            },
            "hubVnetAddressSpace": {
              "type": "string",
              "value": "[variables('vnetAddressSpace')]"
            },
            "hubDefaultSubnetPrefix": {
              "type": "string",
              "value": "[variables('defaultSubnetPrefix')]"
            },
            "hubGatewayPublicIP": {
              "type": "string",
              "value": "[if(parameters('deployGatewayInHub'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', variables('gatewayName'))).outputs.vpnGwPublicIP.value, 'none')]"
            },
            "hubGatewayID": {
              "type": "string",
              "value": "[if(parameters('deployGatewayInHub'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', variables('gatewayName'))).outputs.vpnGwID.value, 'none')]"
            },
            "HubGwBgpPeeringAddress": {
              "type": "string",
              "value": "[if(parameters('deployGatewayInHub'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', variables('gatewayName'))).outputs.vpnGwBgpPeeringAddress.value, 'none')]"
            }
          }
        }
      }
    },
    {
      "condition": "[and(parameters('deployHUB'), equals(parameters('hubType'), 'VWAN'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-{1}-VWAN', parameters('hubRgName'), parameters('location'))]",
      "subscriptionId": "[parameters('hubSubscriptionID')]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "deployFirewallInHub": {
            "value": "[and(parameters('deployFirewallInHub'), equals(parameters('hubType'), 'VWAN'))]"
          },
          "AddressSpace": {
            "value": "[parameters('AddressSpace')]"
          },
          "AzureFirewallTier": {
            "value": "[parameters('AzureFirewallTier')]"
          },
          "deployFirewallrules": {
            "value": "[and(parameters('deployFirewallrules'), equals(parameters('hubType'), 'VWAN'))]"
          },
          "hubRgName": {
            "value": "[parameters('hubRgName')]"
          },
          "deployGatewayInHub": {
            "value": "[and(parameters('deployGatewayInHub'), equals(parameters('hubType'), 'VWAN'))]"
          },
          "tagsByResource": {
            "value": "[parameters('tagsByResource')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1272.37030",
              "templateHash": "13458314379098737952"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "AddressSpace": {
              "type": "string"
            },
            "deployFirewallInHub": {
              "type": "bool"
            },
            "AzureFirewallTier": {
              "type": "string"
            },
            "hubRgName": {
              "type": "string"
            },
            "deployFirewallrules": {
              "type": "bool"
            },
            "deployGatewayInHub": {
              "type": "bool"
            },
            "tagsByResource": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "variables": {
            "vnetAddressSpace": "[replace(parameters('AddressSpace'), '/16', '/24')]",
            "vWanName": "vWAN",
            "firewallName": "Firewall-Hub",
            "gatewayName": "Gateway-Hub"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[parameters('hubRgName')]",
              "location": "[parameters('location')]",
              "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Resources/subscriptions/resourceGroups'), parameters('tagsByResource')['Microsoft.Resources/subscriptions/resourceGroups'], createObject())]"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('vWanName')]",
              "resourceGroup": "[parameters('hubRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "AddressPrefix": {
                    "value": "[variables('vnetAddressSpace')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "vWanName": {
                    "value": "[variables('vWanName')]"
                  },
                  "tagsByResource": {
                    "value": "[parameters('tagsByResource')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "6040531444929936888"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "vWanName": {
                      "type": "string"
                    },
                    "vWanType": {
                      "type": "string",
                      "defaultValue": "Standard",
                      "allowedValues": [
                        "Standard",
                        "Basic"
                      ]
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "AddressPrefix": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualWans",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('vWanName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "type": "[parameters('vWanType')]",
                        "disableVpnEncryption": false,
                        "allowBranchToBranchTraffic": true
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/virtualWans'), parameters('tagsByResource')['Microsoft.Network/virtualWans'], createObject())]"
                    },
                    {
                      "type": "Microsoft.Network/virtualHubs",
                      "apiVersion": "2021-05-01",
                      "name": "[format('HUB-{0}', parameters('location'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "addressPrefix": "[parameters('AddressPrefix')]",
                        "virtualWan": {
                          "id": "[resourceId('Microsoft.Network/virtualWans', parameters('vWanName'))]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/virtualWans', parameters('vWanName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "vWanID": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualWans', parameters('vWanName'))]"
                    },
                    "vWanHubID": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualHubs', format('HUB-{0}', parameters('location')))]"
                    },
                    "vWanHubAddressSpace": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Network/virtualHubs', format('HUB-{0}', parameters('location')))).addressPrefix]"
                    },
                    "vWanHubName": {
                      "type": "string",
                      "value": "[format('HUB-{0}', parameters('location'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('hubRgName'))]"
              ]
            },
            {
              "condition": "[parameters('deployFirewallInHub')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('firewallName')]",
              "resourceGroup": "[parameters('hubRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "deployInVWan": {
                    "value": true
                  },
                  "azfwTier": {
                    "value": "[parameters('AzureFirewallTier')]"
                  },
                  "firewallName": {
                    "value": "[variables('firewallName')]"
                  },
                  "vWanID": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', variables('vWanName'))).outputs.vWanHubID.value]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tagsByResource": {
                    "value": "[parameters('tagsByResource')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "16460631289536220742"
                    }
                  },
                  "parameters": {
                    "firewallName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "azfwTier": {
                      "type": "string",
                      "allowedValues": [
                        "Standard",
                        "Premium"
                      ]
                    },
                    "azfwsubnetid": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "vWanID": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "vWanAzFwPublicIPcount": {
                      "type": "int",
                      "defaultValue": 1
                    },
                    "deployInVWan": {
                      "type": "bool",
                      "defaultValue": false
                    }
                  },
                  "variables": {
                    "azfwSKUname": "[if(parameters('deployInVWan'), 'AZFW_Hub', 'AZFW_VNet')]",
                    "pipName": "[format('{0}-pip', parameters('firewallName'))]",
                    "firewallPolicyName": "[format('{0}-policy', parameters('firewallName'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/azureFirewalls",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('firewallName')]",
                      "location": "[parameters('location')]",
                      "zones": [],
                      "properties": {
                        "sku": {
                          "name": "[variables('azfwSKUname')]",
                          "tier": "[parameters('azfwTier')]"
                        },
                        "firewallPolicy": {
                          "id": "[resourceId('Microsoft.Network/firewallPolicies', variables('firewallPolicyName'))]"
                        },
                        "ipConfigurations": "[if(parameters('deployInVWan'), null(), createArray(createObject('properties', createObject('publicIPAddress', createObject('id', resourceId('Microsoft.Network/publicIPAddresses', variables('pipName'))), 'subnet', createObject('id', parameters('azfwsubnetid'))), 'name', 'ipconfig1')))]",
                        "virtualHub": "[if(parameters('deployInVWan'), createObject('id', parameters('vWanID')), null())]",
                        "hubIPAddresses": "[if(parameters('deployInVWan'), createObject('publicIPs', createObject('count', parameters('vWanAzFwPublicIPcount'))), null())]"
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/azureFirewalls'), parameters('tagsByResource')['Microsoft.Network/azureFirewalls'], createObject())]",
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', variables('pipName'))]",
                        "[resourceId('Microsoft.Network/firewallPolicies', variables('firewallPolicyName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/firewallPolicies",
                      "apiVersion": "2021-05-01",
                      "name": "[variables('firewallPolicyName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "sku": {
                          "tier": "[parameters('azfwTier')]"
                        },
                        "threatIntelMode": "Alert"
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/firewallPolicies'), parameters('tagsByResource')['Microsoft.Network/firewallPolicies'], createObject())]"
                    },
                    {
                      "condition": "[not(parameters('deployInVWan'))]",
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2021-05-01",
                      "name": "[variables('pipName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publicIPAddressVersion": "IPv4",
                        "publicIPAllocationMethod": "Static"
                      },
                      "sku": {
                        "tier": "Regional",
                        "name": "Standard"
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/publicIPAddresses'), parameters('tagsByResource')['Microsoft.Network/publicIPAddresses'], createObject())]"
                    }
                  ],
                  "outputs": {
                    "azFwIP": {
                      "type": "string",
                      "value": "[if(parameters('deployInVWan'), 'None', reference(resourceId('Microsoft.Network/azureFirewalls', parameters('firewallName'))).ipConfigurations[0].properties.privateIPAddress)]"
                    },
                    "azFwIPvWan": {
                      "type": "array",
                      "value": "[if(parameters('deployInVWan'), reference(resourceId('Microsoft.Network/azureFirewalls', parameters('firewallName'))).hubIPAddresses.publicIPs.addresses, createArray())]"
                    },
                    "azFwID": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/azureFirewalls', parameters('firewallName'))]"
                    },
                    "azFwPolicyName": {
                      "type": "string",
                      "value": "[variables('firewallPolicyName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('hubRgName'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', variables('vWanName'))]"
              ]
            },
            {
              "condition": "[and(parameters('deployFirewallrules'), parameters('deployFirewallInHub'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "firewallRules",
              "resourceGroup": "[parameters('hubRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "azFwPolicyName": {
                    "value": "[if(and(parameters('deployFirewallInHub'), parameters('deployFirewallrules')), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', variables('firewallName'))).outputs.azFwPolicyName.value, 'none')]"
                  },
                  "AddressSpace": {
                    "value": "[parameters('AddressSpace')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "2163297474746570044"
                    }
                  },
                  "parameters": {
                    "azFwPolicyName": {
                      "type": "string"
                    },
                    "ruleCollectiongroupName": {
                      "type": "string",
                      "defaultValue": "HubSpokeLabBuilderCollectionGroup"
                    },
                    "AddressSpace": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/firewallPolicies/ruleCollectionGroups",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}/{1}', parameters('azFwPolicyName'), parameters('ruleCollectiongroupName'))]",
                      "properties": {
                        "priority": 400,
                        "ruleCollections": [
                          {
                            "name": "NetworkRules",
                            "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                            "action": {
                              "type": "Allow"
                            },
                            "priority": 100,
                            "rules": [
                              {
                                "name": "AllowLocalTraffic",
                                "ruleType": "NetworkRule",
                                "sourceAddresses": [
                                  "[parameters('AddressSpace')]"
                                ],
                                "destinationAddresses": [
                                  "[parameters('AddressSpace')]"
                                ],
                                "ipProtocols": [
                                  "Any"
                                ],
                                "destinationPorts": [
                                  "*"
                                ]
                              }
                            ]
                          },
                          {
                            "name": "ApplicationRules",
                            "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                            "action": {
                              "type": "Allow"
                            },
                            "priority": 200,
                            "rules": [
                              {
                                "name": "AllowHttpHttps",
                                "ruleType": "ApplicationRule",
                                "sourceAddresses": [
                                  "[parameters('AddressSpace')]"
                                ],
                                "sourceIpGroups": [],
                                "destinationAddresses": [],
                                "terminateTLS": false,
                                "fqdnTags": [],
                                "webCategories": [],
                                "targetUrls": [],
                                "targetFqdns": [
                                  "*"
                                ],
                                "protocols": [
                                  {
                                    "protocolType": "Http",
                                    "port": 80
                                  },
                                  {
                                    "protocolType": "Https",
                                    "port": 443
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', variables('firewallName'))]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('hubRgName'))]"
              ]
            },
            {
              "condition": "[parameters('deployFirewallInHub')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "secureRoutes",
              "resourceGroup": "[parameters('hubRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "vwanHubName": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', variables('vWanName'))).outputs.vWanHubName.value]"
                  },
                  "AzFirewallID": {
                    "value": "[if(parameters('deployFirewallInHub'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', variables('firewallName'))).outputs.azFwID.value, 'none')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "13227356620781286820"
                    }
                  },
                  "parameters": {
                    "vwanHubName": {
                      "type": "string"
                    },
                    "AzFirewallID": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualHubs/hubRouteTables",
                      "apiVersion": "2020-05-01",
                      "name": "[format('{0}/defaultRouteTable', parameters('vwanHubName'))]",
                      "properties": {
                        "routes": [
                          {
                            "name": "all_traffic",
                            "destinationType": "CIDR",
                            "destinations": [
                              "10.0.0.0/8",
                              "172.16.0.0/12",
                              "192.168.0.0/16",
                              "0.0.0.0/0"
                            ],
                            "nextHopType": "ResourceId",
                            "nextHop": "[parameters('AzFirewallID')]"
                          }
                        ],
                        "labels": [
                          "default"
                        ]
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', variables('firewallName'))]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('hubRgName'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', variables('vWanName'))]"
              ]
            },
            {
              "condition": "[parameters('deployGatewayInHub')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('gatewayName')]",
              "resourceGroup": "[parameters('hubRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "vpnGwName": {
                    "value": "[variables('gatewayName')]"
                  },
                  "vWanHubID": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', variables('vWanName'))).outputs.vWanHubID.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "6375147052164896541"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "vWanHubID": {
                      "type": "string"
                    },
                    "vpnGwName": {
                      "type": "string"
                    },
                    "vpnGwScaleUnits": {
                      "type": "int",
                      "defaultValue": 1,
                      "maxValue": 25,
                      "minValue": 1
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/vpnGateways",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('vpnGwName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "bgpSettings": {
                          "asn": 65515
                        },
                        "vpnGatewayScaleUnit": "[parameters('vpnGwScaleUnits')]",
                        "virtualHub": {
                          "id": "[parameters('vWanHubID')]"
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "vpnGwID": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/vpnGateways', parameters('vpnGwName'))]"
                    },
                    "vpnGwPip": {
                      "type": "array",
                      "value": "[reference(resourceId('Microsoft.Network/vpnGateways', parameters('vpnGwName'))).ipConfigurations]"
                    },
                    "vpnGwBgpIp": {
                      "type": "array",
                      "value": "[reference(resourceId('Microsoft.Network/vpnGateways', parameters('vpnGwName'))).bgpSettings.bgpPeeringAddresses]"
                    },
                    "vpnGwBgpAsn": {
                      "type": "int",
                      "value": "[reference(resourceId('Microsoft.Network/vpnGateways', parameters('vpnGwName'))).bgpSettings.asn]"
                    },
                    "vpnGwName": {
                      "type": "string",
                      "value": "[parameters('vpnGwName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('hubRgName'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', variables('vWanName'))]"
              ]
            }
          ],
          "outputs": {
            "vwanHubName": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', variables('vWanName'))).outputs.vWanHubName.value]"
            },
            "vWanHubID": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', variables('vWanName'))).outputs.vWanHubID.value]"
            },
            "vWanID": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', variables('vWanName'))).outputs.vWanID.value]"
            },
            "vWanHubAddressSpace": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', variables('vWanName'))).outputs.vWanHubAddressSpace.value]"
            },
            "HubResourceGroupName": {
              "type": "string",
              "value": "[parameters('hubRgName')]"
            },
            "vWanVpnGwID": {
              "type": "string",
              "value": "[if(parameters('deployGatewayInHub'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', variables('gatewayName'))).outputs.vpnGwID.value, 'none')]"
            },
            "vWanVpnGwPip": {
              "type": "array",
              "value": "[if(parameters('deployGatewayInHub'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', variables('gatewayName'))).outputs.vpnGwPip.value, createArray())]"
            },
            "vWanFwPublicIP": {
              "type": "array",
              "value": "[if(parameters('deployFirewallInHub'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', variables('firewallName'))).outputs.azFwIPvWan.value, createArray())]"
            },
            "vpnGwBgpIp": {
              "type": "array",
              "value": "[if(parameters('deployGatewayInHub'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', variables('gatewayName'))).outputs.vpnGwBgpIp.value, createArray())]"
            },
            "vpnGwBgpAsn": {
              "type": "int",
              "value": "[if(parameters('deployGatewayInHub'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', variables('gatewayName'))).outputs.vpnGwBgpAsn.value, 0)]"
            },
            "vpnGwName": {
              "type": "string",
              "value": "[if(parameters('deployGatewayInHub'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubRgName')), 'Microsoft.Resources/deployments', variables('gatewayName'))).outputs.vpnGwName.value, 'none')]"
            }
          }
        }
      }
    },
    {
      "condition": "[parameters('deploySpokes')]",
      "copy": {
        "name": "spokeVnets",
        "count": "[length(range(1, parameters('amountOfSpokes')))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}{1}-{2}', parameters('spokeRgNamePrefix'), range(1, parameters('amountOfSpokes'))[copyIndex()], parameters('location'))]",
      "subscriptionId": "[parameters('spokeSubscriptionID')]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "counter": {
            "value": "[range(1, parameters('amountOfSpokes'))[copyIndex()]]"
          },
          "AddressSpace": {
            "value": "[parameters('AddressSpace')]"
          },
          "deployBastionInSpoke": {
            "value": "[parameters('deployBastionInSpoke')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "deployVMsInSpokes": {
            "value": "[parameters('deployVMsInSpokes')]"
          },
          "deployFirewallInHub": {
            "value": "[and(parameters('deployFirewallInHub'), equals(parameters('hubType'), 'VNET'))]"
          },
          "AzureFirewallpip": {
            "value": "[if(and(parameters('deployHUB'), equals(parameters('hubType'), 'VNET')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VNET', parameters('hubRgName'), parameters('location')))).outputs.azFwIp.value, 'Not deployed')]"
          },
          "HubDeployed": {
            "value": "[and(parameters('deployHUB'), equals(parameters('hubType'), 'VNET'))]"
          },
          "spokeRgNamePrefix": {
            "value": "[parameters('spokeRgNamePrefix')]"
          },
          "vmSize": {
            "value": "[parameters('vmSizeSpoke')]"
          },
          "tagsByResource": {
            "value": "[parameters('tagsByResource')]"
          },
          "osType": {
            "value": "[parameters('osTypeSpoke')]"
          },
          "hubDefaultSubnetPrefix": {
            "value": "[if(and(parameters('deployHUB'), equals(parameters('hubType'), 'VNET')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VNET', parameters('hubRgName'), parameters('location')))).outputs.hubDefaultSubnetPrefix.value, 'Not deployed')]"
          },
          "deployUDRs": {
            "value": "[parameters('deployUDRs')]"
          },
          "bastionSku": {
            "value": "[parameters('bastionInSpokeSKU')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1272.37030",
              "templateHash": "4410623329111262833"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "AddressSpace": {
              "type": "string"
            },
            "counter": {
              "type": "int"
            },
            "deployBastionInSpoke": {
              "type": "bool"
            },
            "bastionSku": {
              "type": "string"
            },
            "adminUsername": {
              "type": "string"
            },
            "adminPassword": {
              "type": "secureString"
            },
            "deployVMsInSpokes": {
              "type": "bool"
            },
            "deployFirewallInHub": {
              "type": "bool"
            },
            "deployUDRs": {
              "type": "bool"
            },
            "AzureFirewallpip": {
              "type": "string"
            },
            "HubDeployed": {
              "type": "bool"
            },
            "spokeRgNamePrefix": {
              "type": "string"
            },
            "vmSize": {
              "type": "string"
            },
            "tagsByResource": {
              "type": "object"
            },
            "osType": {
              "type": "string"
            },
            "hubDefaultSubnetPrefix": {
              "type": "string"
            }
          },
          "variables": {
            "vnetName": "[format('VNET-Spoke{0}', parameters('counter'))]",
            "vmName": "[format('VM-Spoke{0}', parameters('counter'))]",
            "rtName": "[format('RT-Spoke{0}', parameters('counter'))]",
            "nsgName": "[format('NSG-Spoke{0}', parameters('counter'))]",
            "bastionName": "[format('Bastion-Spoke{0}', parameters('counter'))]",
            "vnetAddressSpace": "[replace(parameters('AddressSpace'), '0.0/16', format('{0}.0/24', parameters('counter')))]",
            "defaultSubnetPrefix": "[replace(variables('vnetAddressSpace'), '/24', '/26')]",
            "bastionSubnetPrefix": "[replace(variables('vnetAddressSpace'), '0/24', '128/27')]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter'))]",
              "location": "[parameters('location')]",
              "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Resources/subscriptions/resourceGroups'), parameters('tagsByResource')['Microsoft.Resources/subscriptions/resourceGroups'], createObject())]"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('vnetName')]",
              "resourceGroup": "[format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "vnetAddressSpcae": {
                    "value": "[variables('vnetAddressSpace')]"
                  },
                  "nsgID": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter'))), 'Microsoft.Resources/deployments', variables('nsgName'))).outputs.nsgID.value]"
                  },
                  "rtDefID": {
                    "value": "[if(and(and(parameters('deployFirewallInHub'), parameters('HubDeployed')), parameters('deployUDRs')), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter'))), 'Microsoft.Resources/deployments', variables('rtName'))).outputs.rtID.value, 'none')]"
                  },
                  "vnetname": {
                    "value": "[variables('vnetName')]"
                  },
                  "defaultSubnetPrefix": {
                    "value": "[variables('defaultSubnetPrefix')]"
                  },
                  "bastionSubnetPrefix": {
                    "value": "[if(parameters('deployBastionInSpoke'), variables('bastionSubnetPrefix'), '')]"
                  },
                  "deployBastionSubnet": {
                    "value": "[parameters('deployBastionInSpoke')]"
                  },
                  "tagsByResource": {
                    "value": "[parameters('tagsByResource')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "15972562488758076476"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "vnetname": {
                      "type": "string"
                    },
                    "vnetAddressSpcae": {
                      "type": "string"
                    },
                    "defaultSubnetPrefix": {
                      "type": "string"
                    },
                    "bastionSubnetPrefix": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "firewallSubnetPrefix": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "GatewaySubnetPrefix": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "nsgID": {
                      "type": "string"
                    },
                    "rtDefID": {
                      "type": "string",
                      "defaultValue": "none"
                    },
                    "rtGwID": {
                      "type": "string",
                      "defaultValue": "none"
                    },
                    "deployBastionSubnet": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "deployFirewallSubnet": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "deployGatewaySubnet": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "variables": {
                    "defaultSubnet": [
                      {
                        "name": "default",
                        "properties": {
                          "addressPrefix": "[parameters('defaultSubnetPrefix')]",
                          "networkSecurityGroup": {
                            "id": "[parameters('nsgID')]"
                          },
                          "routeTable": "[if(equals(parameters('rtDefID'), 'none'), json('null'), json(format('{{\"id\": \"{0}\"}}\"', parameters('rtDefID'))))]"
                        }
                      }
                    ],
                    "bastionSubnet": "[if(not(parameters('deployBastionSubnet')), createArray(), createArray(createObject('name', 'AzureBastionSubnet', 'properties', createObject('addressPrefix', parameters('bastionSubnetPrefix')))))]",
                    "firewallSubnet": "[if(not(parameters('deployFirewallSubnet')), createArray(), createArray(createObject('name', 'AzureFirewallSubnet', 'properties', createObject('addressPrefix', parameters('firewallSubnetPrefix')))))]",
                    "gatewaySubnet": "[if(and(not(parameters('deployGatewaySubnet')), not(parameters('deployFirewallSubnet'))), createArray(), createArray(createObject('name', 'GatewaySubnet', 'properties', createObject('addressPrefix', parameters('GatewaySubnetPrefix'), 'routeTable', if(equals(parameters('rtGwID'), 'none'), json('null'), json(format('{{\"id\": \"{0}\"}}\"', parameters('rtGwID'))))))))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('vnetname')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('vnetAddressSpcae')]"
                          ]
                        },
                        "subnets": "[concat(variables('defaultSubnet'), variables('bastionSubnet'), variables('firewallSubnet'), variables('gatewaySubnet'))]"
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/virtualNetworks'), parameters('tagsByResource')['Microsoft.Network/virtualNetworks'], createObject())]"
                    }
                  ],
                  "outputs": {
                    "vnetName": {
                      "type": "string",
                      "value": "[parameters('vnetname')]"
                    },
                    "vnetID": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetname'))]"
                    },
                    "defaultSubnetID": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetname'))).subnets[0].id]"
                    },
                    "bastionSubnetID": {
                      "type": "string",
                      "value": "[if(parameters('deployBastionSubnet'), resourceId('Microsoft.Network/VirtualNetworks/subnets', parameters('vnetname'), 'AzureBastionSubnet'), 'Not deployed')]"
                    },
                    "firewallSubnetID": {
                      "type": "string",
                      "value": "[if(parameters('deployFirewallSubnet'), resourceId('Microsoft.Network/VirtualNetworks/subnets', parameters('vnetname'), 'AzureFirewallSubnet'), 'Not deployed')]"
                    },
                    "gatewaySubnetID": {
                      "type": "string",
                      "value": "[if(parameters('deployGatewaySubnet'), resourceId('Microsoft.Network/VirtualNetworks/subnets', parameters('vnetname'), 'GatewaySubnet'), 'Not deployed')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter'))), 'Microsoft.Resources/deployments', variables('nsgName'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter'))), 'Microsoft.Resources/deployments', variables('rtName'))]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter')))]"
              ]
            },
            {
              "condition": "[parameters('deployVMsInSpokes')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('vmName')]",
              "resourceGroup": "[format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "adminPassword": {
                    "value": "[parameters('adminPassword')]"
                  },
                  "adminUsername": {
                    "value": "[parameters('adminUsername')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "subnetID": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter'))), 'Microsoft.Resources/deployments', variables('vnetName'))).outputs.defaultSubnetID.value]"
                  },
                  "vmName": {
                    "value": "[variables('vmName')]"
                  },
                  "vmSize": {
                    "value": "[parameters('vmSize')]"
                  },
                  "tagsByResource": {
                    "value": "[parameters('tagsByResource')]"
                  },
                  "osType": {
                    "value": "[parameters('osType')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "8734156456072154768"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "vmName": {
                      "type": "string"
                    },
                    "adminUsername": {
                      "type": "string"
                    },
                    "adminPassword": {
                      "type": "secureString"
                    },
                    "subnetID": {
                      "type": "string"
                    },
                    "vmSize": {
                      "type": "string"
                    },
                    "storageType": {
                      "type": "string",
                      "defaultValue": "StandardSSD_LRS"
                    },
                    "osType": {
                      "type": "string",
                      "defaultValue": "Windows"
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "variables": {
                    "EnableICMPv4": "netsh advfirewall firewall add rule name=\"ICMP Allow incoming V4 echo request\" protocol=\"icmpv4:8,any\" dir=in action=allow",
                    "Windows": {
                      "publisher": "MicrosoftWindowsServer",
                      "offer": "WindowsServer",
                      "sku": "2022-datacenter-g2",
                      "version": "latest"
                    },
                    "Linux": {
                      "publisher": "Canonical",
                      "offer": "0001-com-ubuntu-server-jammy",
                      "sku": "22_04-lts-gen2",
                      "version": "latest"
                    },
                    "imagereference": "[if(equals(parameters('osType'), 'Windows'), variables('Windows'), if(equals(parameters('osType'), 'Linux'), variables('Linux'), createObject()))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2021-11-01",
                      "name": "[parameters('vmName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "osProfile": {
                          "computerName": "[parameters('vmName')]",
                          "adminUsername": "[parameters('adminUsername')]",
                          "adminPassword": "[parameters('adminPassword')]"
                        },
                        "storageProfile": {
                          "imageReference": "[variables('imagereference')]",
                          "osDisk": {
                            "createOption": "FromImage",
                            "managedDisk": {
                              "storageAccountType": "[parameters('storageType')]"
                            },
                            "osType": "[parameters('osType')]",
                            "deleteOption": "Delete"
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-nic', parameters('vmName')))]",
                              "properties": {
                                "deleteOption": "Delete"
                              }
                            }
                          ]
                        },
                        "hardwareProfile": {
                          "vmSize": "[parameters('vmSize')]"
                        },
                        "diagnosticsProfile": {
                          "bootDiagnostics": {
                            "enabled": true
                          }
                        }
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Compute/virtualMachines'), parameters('tagsByResource')['Microsoft.Compute/virtualMachines'], createObject())]",
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-nic', parameters('vmName')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}-nic', parameters('vmName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "ipconfig1",
                            "properties": {
                              "primary": true,
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[parameters('subnetID')]"
                              }
                            }
                          }
                        ]
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Compute/virtualMachines'), parameters('tagsByResource')['Microsoft.Compute/virtualMachines'], createObject())]"
                    },
                    {
                      "condition": "[equals(parameters('osType'), 'Windows')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[format('{0}-runCommand', parameters('vmName'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "runCommand": {
                            "value": "[variables('EnableICMPv4')]"
                          },
                          "vmName": {
                            "value": "[parameters('vmName')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.1272.37030",
                              "templateHash": "13065007741233957351"
                            }
                          },
                          "parameters": {
                            "location": {
                              "type": "string"
                            },
                            "vmName": {
                              "type": "string"
                            },
                            "runName": {
                              "type": "string",
                              "defaultValue": "RunCommand"
                            },
                            "runCommand": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Compute/virtualMachines/runCommands",
                              "apiVersion": "2021-11-01",
                              "name": "[format('{0}/{1}', parameters('vmName'), parameters('runName'))]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "source": {
                                  "script": "[parameters('runCommand')]"
                                },
                                "timeoutInSeconds": 60
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter')))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter'))), 'Microsoft.Resources/deployments', variables('vnetName'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('nsgName')]",
              "resourceGroup": "[format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "nsgName": {
                    "value": "[variables('nsgName')]"
                  },
                  "tagsByResource": {
                    "value": "[parameters('tagsByResource')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "4986852817278939313"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "nsgName": {
                      "type": "string"
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('nsgName')]",
                      "location": "[parameters('location')]",
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/networkSecurityGroups'), parameters('tagsByResource')['Microsoft.Network/networkSecurityGroups'], createObject())]"
                    }
                  ],
                  "outputs": {
                    "nsgID": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter')))]"
              ]
            },
            {
              "condition": "[parameters('deployBastionInSpoke')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('bastionName')]",
              "resourceGroup": "[format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "subnetID": {
                    "value": "[if(parameters('deployBastionInSpoke'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter'))), 'Microsoft.Resources/deployments', variables('vnetName'))).outputs.bastionSubnetID.value, '')]"
                  },
                  "bastionName": {
                    "value": "[variables('bastionName')]"
                  },
                  "tagsByResource": {
                    "value": "[parameters('tagsByResource')]"
                  },
                  "bastionSku": {
                    "value": "[parameters('bastionSku')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "5886547612277966671"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "bastionName": {
                      "type": "string"
                    },
                    "subnetID": {
                      "type": "string"
                    },
                    "bastionSku": {
                      "type": "string",
                      "allowedValues": [
                        "Basic",
                        "Standard"
                      ]
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/bastionHosts",
                      "apiVersion": "2021-03-01",
                      "name": "[parameters('bastionName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "IpConf",
                            "properties": {
                              "subnet": {
                                "id": "[parameters('subnetID')]"
                              },
                              "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-pip', parameters('bastionName')))]"
                              }
                            }
                          }
                        ]
                      },
                      "sku": {
                        "name": "[parameters('bastionSku')]"
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/bastionHosts'), parameters('tagsByResource')['Microsoft.Network/bastionHosts'], createObject())]",
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-pip', parameters('bastionName')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}-pip', parameters('bastionName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publicIPAddressVersion": "IPv4",
                        "publicIPAllocationMethod": "Static"
                      },
                      "sku": {
                        "tier": "Regional",
                        "name": "Standard"
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/publicIPAddresses'), parameters('tagsByResource')['Microsoft.Network/publicIPAddresses'], createObject())]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter')))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter'))), 'Microsoft.Resources/deployments', variables('vnetName'))]"
              ]
            },
            {
              "condition": "[and(and(parameters('deployFirewallInHub'), parameters('HubDeployed')), parameters('deployUDRs'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('rtName')]",
              "resourceGroup": "[format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "rtName": {
                    "value": "[variables('rtName')]"
                  },
                  "tagsByResource": {
                    "value": "[parameters('tagsByResource')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "7736955651557094540"
                    }
                  },
                  "parameters": {
                    "rtName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "disableRouteProp": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/routeTables",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('rtName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "disableBgpRoutePropagation": "[parameters('disableRouteProp')]"
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/routeTables'), parameters('tagsByResource')['Microsoft.Network/routeTables'], createObject())]"
                    }
                  ],
                  "outputs": {
                    "rtID": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/routeTables', parameters('rtName'))]"
                    },
                    "rtName": {
                      "type": "string",
                      "value": "[parameters('rtName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter')))]"
              ]
            },
            {
              "condition": "[and(and(parameters('deployFirewallInHub'), parameters('HubDeployed')), parameters('deployUDRs'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "RouteToInternet",
              "resourceGroup": "[format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "routeAddressPrefix": {
                    "value": "0.0.0.0/0"
                  },
                  "routeName": {
                    "value": "[if(and(and(parameters('deployFirewallInHub'), parameters('HubDeployed')), parameters('deployUDRs')), format('{0}/toInternet', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter'))), 'Microsoft.Resources/deployments', variables('rtName'))).outputs.rtName.value), 'dummy1')]"
                  },
                  "routeNextHopIpAddress": {
                    "value": "[if(and(and(parameters('deployFirewallInHub'), parameters('HubDeployed')), parameters('deployUDRs')), parameters('AzureFirewallpip'), '1.2.3.4')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "8096143721828499520"
                    }
                  },
                  "parameters": {
                    "routeName": {
                      "type": "string"
                    },
                    "routeNextHopType": {
                      "type": "string",
                      "defaultValue": "VirtualAppliance"
                    },
                    "routeAddressPrefix": {
                      "type": "string"
                    },
                    "routeNextHopIpAddress": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/routeTables/routes",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('routeName')]",
                      "properties": {
                        "nextHopType": "[parameters('routeNextHopType')]",
                        "addressPrefix": "[parameters('routeAddressPrefix')]",
                        "nextHopIpAddress": "[parameters('routeNextHopIpAddress')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter'))), 'Microsoft.Resources/deployments', variables('rtName'))]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter')))]"
              ]
            },
            {
              "condition": "[and(and(parameters('deployFirewallInHub'), parameters('HubDeployed')), parameters('deployUDRs'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "RouteToLocal",
              "resourceGroup": "[format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "routeAddressPrefix": {
                    "value": "[parameters('hubDefaultSubnetPrefix')]"
                  },
                  "routeName": {
                    "value": "[if(and(and(parameters('deployFirewallInHub'), parameters('HubDeployed')), parameters('deployUDRs')), format('{0}/toHubDefaultSubnet', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter'))), 'Microsoft.Resources/deployments', variables('rtName'))).outputs.rtName.value), 'dummy2')]"
                  },
                  "routeNextHopIpAddress": {
                    "value": "[if(and(and(parameters('deployFirewallInHub'), parameters('HubDeployed')), parameters('deployUDRs')), parameters('AzureFirewallpip'), '1.2.3.4')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "8096143721828499520"
                    }
                  },
                  "parameters": {
                    "routeName": {
                      "type": "string"
                    },
                    "routeNextHopType": {
                      "type": "string",
                      "defaultValue": "VirtualAppliance"
                    },
                    "routeAddressPrefix": {
                      "type": "string"
                    },
                    "routeNextHopIpAddress": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/routeTables/routes",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('routeName')]",
                      "properties": {
                        "nextHopType": "[parameters('routeNextHopType')]",
                        "addressPrefix": "[parameters('routeAddressPrefix')]",
                        "nextHopIpAddress": "[parameters('routeNextHopIpAddress')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter'))), 'Microsoft.Resources/deployments', variables('rtName'))]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter')))]"
              ]
            }
          ],
          "outputs": {
            "spokeVnetID": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter'))), 'Microsoft.Resources/deployments', variables('vnetName'))).outputs.vnetID.value]"
            },
            "spokeVnetAddressSpace": {
              "type": "string",
              "value": "[variables('vnetAddressSpace')]"
            },
            "spokeResourceGroupName": {
              "type": "string",
              "value": "[format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter'))]"
            },
            "spokeVnetName": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}{1}', parameters('spokeRgNamePrefix'), parameters('counter'))), 'Microsoft.Resources/deployments', variables('vnetName'))).outputs.vnetName.value]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VNET', parameters('hubRgName'), parameters('location')))]"
      ]
    },
    {
      "condition": "[and(and(parameters('deployHUB'), parameters('deploySpokes')), equals(parameters('hubType'), 'VNET'))]",
      "copy": {
        "name": "vnetPeerings",
        "count": "[length(range(0, parameters('amountOfSpokes')))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-VnetPeering{1}-{2}', parameters('hubRgName'), add(range(0, parameters('amountOfSpokes'))[copyIndex()], 1), parameters('location'))]",
      "subscriptionId": "[parameters('hubSubscriptionID')]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "HubResourceGroupName": {
            "value": "[if(and(and(parameters('deployHUB'), parameters('deploySpokes')), equals(parameters('hubType'), 'VNET')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VNET', parameters('hubRgName'), parameters('location')))).outputs.HubResourceGroupName.value, 'No VNET peering')]"
          },
          "SpokeResourceGroupName": {
            "value": "[if(and(and(parameters('deployHUB'), parameters('deploySpokes')), equals(parameters('hubType'), 'VNET')), reference(subscriptionResourceId(parameters('spokeSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}{1}-{2}', parameters('spokeRgNamePrefix'), range(1, parameters('amountOfSpokes'))[range(0, parameters('amountOfSpokes'))[copyIndex()]], parameters('location')))).outputs.spokeResourceGroupName.value, 'No peering')]"
          },
          "HubVnetName": {
            "value": "[if(and(and(parameters('deployHUB'), parameters('deploySpokes')), equals(parameters('hubType'), 'VNET')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VNET', parameters('hubRgName'), parameters('location')))).outputs.hubVnetName.value, 'No VNET peering')]"
          },
          "SpokeVnetID": {
            "value": "[if(and(and(parameters('deployHUB'), parameters('deploySpokes')), equals(parameters('hubType'), 'VNET')), reference(subscriptionResourceId(parameters('spokeSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}{1}-{2}', parameters('spokeRgNamePrefix'), range(1, parameters('amountOfSpokes'))[range(0, parameters('amountOfSpokes'))[copyIndex()]], parameters('location')))).outputs.spokeVnetID.value, 'No VNET peering')]"
          },
          "HubVnetID": {
            "value": "[if(and(and(parameters('deployHUB'), parameters('deploySpokes')), equals(parameters('hubType'), 'VNET')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VNET', parameters('hubRgName'), parameters('location')))).outputs.hubVnetID.value, 'No VNET peering')]"
          },
          "SpokeVnetName": {
            "value": "[if(and(and(parameters('deployHUB'), parameters('deploySpokes')), equals(parameters('hubType'), 'VNET')), reference(subscriptionResourceId(parameters('spokeSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}{1}-{2}', parameters('spokeRgNamePrefix'), range(1, parameters('amountOfSpokes'))[range(0, parameters('amountOfSpokes'))[copyIndex()]], parameters('location')))).outputs.spokeVnetName.value, 'No VNET peering')]"
          },
          "counter": {
            "value": "[range(0, parameters('amountOfSpokes'))[copyIndex()]]"
          },
          "GatewayDeployed": {
            "value": "[parameters('deployGatewayInHub')]"
          },
          "hubSubscriptionID": {
            "value": "[parameters('hubSubscriptionID')]"
          },
          "spokeSubscriptionID": {
            "value": "[parameters('spokeSubscriptionID')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1272.37030",
              "templateHash": "11432441034622857571"
            }
          },
          "parameters": {
            "HubResourceGroupName": {
              "type": "string"
            },
            "SpokeResourceGroupName": {
              "type": "string"
            },
            "HubVnetName": {
              "type": "string"
            },
            "SpokeVnetName": {
              "type": "string"
            },
            "HubVnetID": {
              "type": "string"
            },
            "SpokeVnetID": {
              "type": "string"
            },
            "counter": {
              "type": "int"
            },
            "GatewayDeployed": {
              "type": "bool"
            },
            "hubSubscriptionID": {
              "type": "string"
            },
            "spokeSubscriptionID": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('peeringToSpoke{0}', add(parameters('counter'), 1))]",
              "subscriptionId": "[parameters('hubSubscriptionID')]",
              "resourceGroup": "[parameters('HubResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "peeringName": {
                    "value": "[format('{0}/peeringToSpoke{1}', parameters('HubVnetName'), add(parameters('counter'), 1))]"
                  },
                  "remoteVnetID": {
                    "value": "[parameters('SpokeVnetID')]"
                  },
                  "useRemoteGateways": {
                    "value": false
                  },
                  "allowGatewayTransit": {
                    "value": "[parameters('GatewayDeployed')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "8190748004866178373"
                    }
                  },
                  "parameters": {
                    "remoteVnetID": {
                      "type": "string"
                    },
                    "peeringName": {
                      "type": "string"
                    },
                    "allowForwardedTraffic": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "allowGatewayTransit": {
                      "type": "bool"
                    },
                    "allowVirtualNetworkAccess": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "useRemoteGateways": {
                      "type": "bool"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('peeringName')]",
                      "properties": {
                        "remoteVirtualNetwork": {
                          "id": "[parameters('remoteVnetID')]"
                        },
                        "allowForwardedTraffic": "[parameters('allowForwardedTraffic')]",
                        "allowGatewayTransit": "[parameters('allowGatewayTransit')]",
                        "allowVirtualNetworkAccess": "[parameters('allowVirtualNetworkAccess')]",
                        "useRemoteGateways": "[parameters('useRemoteGateways')]"
                      }
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('peeringToHub{0}', add(parameters('counter'), 1))]",
              "subscriptionId": "[parameters('spokeSubscriptionID')]",
              "resourceGroup": "[parameters('SpokeResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "peeringName": {
                    "value": "[format('{0}/peeringToHub{1}', parameters('SpokeVnetName'), add(parameters('counter'), 1))]"
                  },
                  "remoteVnetID": {
                    "value": "[parameters('HubVnetID')]"
                  },
                  "useRemoteGateways": {
                    "value": "[parameters('GatewayDeployed')]"
                  },
                  "allowGatewayTransit": {
                    "value": false
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "8190748004866178373"
                    }
                  },
                  "parameters": {
                    "remoteVnetID": {
                      "type": "string"
                    },
                    "peeringName": {
                      "type": "string"
                    },
                    "allowForwardedTraffic": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "allowGatewayTransit": {
                      "type": "bool"
                    },
                    "allowVirtualNetworkAccess": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "useRemoteGateways": {
                      "type": "bool"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('peeringName')]",
                      "properties": {
                        "remoteVirtualNetwork": {
                          "id": "[parameters('remoteVnetID')]"
                        },
                        "allowForwardedTraffic": "[parameters('allowForwardedTraffic')]",
                        "allowGatewayTransit": "[parameters('allowGatewayTransit')]",
                        "allowVirtualNetworkAccess": "[parameters('allowVirtualNetworkAccess')]",
                        "useRemoteGateways": "[parameters('useRemoteGateways')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionID'), parameters('HubResourceGroupName')), 'Microsoft.Resources/deployments', format('peeringToSpoke{0}', add(parameters('counter'), 1)))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VNET', parameters('hubRgName'), parameters('location')))]",
        "[subscriptionResourceId(parameters('spokeSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}{1}-{2}', parameters('spokeRgNamePrefix'), range(1, parameters('amountOfSpokes'))[range(0, parameters('amountOfSpokes'))[copyIndex()]], parameters('location')))]",
        "[subscriptionResourceId(parameters('spokeSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}{1}-{2}', parameters('spokeRgNamePrefix'), range(1, parameters('amountOfSpokes'))[range(0, parameters('amountOfSpokes'))[copyIndex()]], parameters('location')))]",
        "[subscriptionResourceId(parameters('spokeSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}{1}-{2}', parameters('spokeRgNamePrefix'), range(1, parameters('amountOfSpokes'))[range(0, parameters('amountOfSpokes'))[copyIndex()]], parameters('location')))]"
      ]
    },
    {
      "condition": "[and(and(parameters('deployHUB'), parameters('deploySpokes')), equals(parameters('hubType'), 'VWAN'))]",
      "copy": {
        "name": "vnetConnections",
        "count": "[length(range(0, parameters('amountOfSpokes')))]",
        "mode": "serial",
        "batchSize": 1
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-VnetConnection{1}-{2}', parameters('hubRgName'), add(range(0, parameters('amountOfSpokes'))[copyIndex()], 1), parameters('location'))]",
      "subscriptionId": "[parameters('hubSubscriptionID')]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "HubResourceGroupName": {
            "value": "[if(and(and(parameters('deployHUB'), parameters('deploySpokes')), equals(parameters('hubType'), 'VWAN')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VWAN', parameters('hubRgName'), parameters('location')))).outputs.HubResourceGroupName.value, 'No VNET peering')]"
          },
          "SpokeVnetID": {
            "value": "[if(and(and(parameters('deployHUB'), parameters('deploySpokes')), equals(parameters('hubType'), 'VWAN')), reference(subscriptionResourceId(parameters('spokeSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}{1}-{2}', parameters('spokeRgNamePrefix'), range(1, parameters('amountOfSpokes'))[range(0, parameters('amountOfSpokes'))[copyIndex()]], parameters('location')))).outputs.spokeVnetID.value, 'No VNET peering')]"
          },
          "vwanHubName": {
            "value": "[if(and(and(parameters('deployHUB'), parameters('deploySpokes')), equals(parameters('hubType'), 'VWAN')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VWAN', parameters('hubRgName'), parameters('location')))).outputs.vwanHubName.value, 'No VNET peering')]"
          },
          "deployFirewallInHub": {
            "value": "[and(parameters('deployFirewallInHub'), equals(parameters('hubType'), 'VWAN'))]"
          },
          "counter": {
            "value": "[range(0, parameters('amountOfSpokes'))[copyIndex()]]"
          },
          "hubSubscriptionID": {
            "value": "[parameters('hubSubscriptionID')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1272.37030",
              "templateHash": "14964860665093012933"
            }
          },
          "parameters": {
            "vwanHubName": {
              "type": "string"
            },
            "SpokeVnetID": {
              "type": "string"
            },
            "HubResourceGroupName": {
              "type": "string"
            },
            "counter": {
              "type": "int"
            },
            "deployFirewallInHub": {
              "type": "bool"
            },
            "hubSubscriptionID": {
              "type": "string"
            }
          },
          "variables": {
            "spokeName": "[split(parameters('SpokeVnetID'), '/')[8]]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('VnetConnection{0}', add(parameters('counter'), 1))]",
              "subscriptionId": "[parameters('hubSubscriptionID')]",
              "resourceGroup": "[parameters('HubResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "SpokeVnetID": {
                    "value": "[parameters('SpokeVnetID')]"
                  },
                  "vwanHubName": {
                    "value": "[parameters('vwanHubName')]"
                  },
                  "spokeName": {
                    "value": "[variables('spokeName')]"
                  },
                  "enableInternetSecurity": {
                    "value": true
                  },
                  "propagateToNoneRouteTable": {
                    "value": "[parameters('deployFirewallInHub')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "17299520606060847175"
                    }
                  },
                  "parameters": {
                    "vwanHubName": {
                      "type": "string"
                    },
                    "spokeName": {
                      "type": "string"
                    },
                    "SpokeVnetID": {
                      "type": "string"
                    },
                    "enableInternetSecurity": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "propagateToNoneRouteTable": {
                      "type": "bool",
                      "defaultValue": false
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualHubs/hubVirtualNetworkConnections",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}/{1}-to-{2}', parameters('vwanHubName'), parameters('vwanHubName'), parameters('spokeName'))]",
                      "properties": {
                        "routingConfiguration": {
                          "associatedRouteTable": {
                            "id": "[resourceId('Microsoft.Network/virtualHubs/hubRouteTables', parameters('vwanHubName'), 'defaultRouteTable')]"
                          },
                          "propagatedRouteTables": {
                            "labels": [
                              "[if(parameters('propagateToNoneRouteTable'), '', 'default')]"
                            ],
                            "ids": [
                              {
                                "id": "[resourceId('Microsoft.Network/virtualHubs/hubRouteTables', parameters('vwanHubName'), if(parameters('propagateToNoneRouteTable'), 'noneRouteTable', 'defaultRouteTable'))]"
                              }
                            ]
                          }
                        },
                        "remoteVirtualNetwork": {
                          "id": "[parameters('SpokeVnetID')]"
                        },
                        "enableInternetSecurity": "[parameters('enableInternetSecurity')]"
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId(parameters('spokeSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}{1}-{2}', parameters('spokeRgNamePrefix'), range(1, parameters('amountOfSpokes'))[range(0, parameters('amountOfSpokes'))[copyIndex()]], parameters('location')))]",
        "[subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VWAN', parameters('hubRgName'), parameters('location')))]"
      ]
    },
    {
      "condition": "[parameters('deployOnPrem')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-{1}', parameters('onpremRgName'), parameters('location'))]",
      "subscriptionId": "[parameters('onPremSubscriptionID')]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "AddressSpace": {
            "value": "[parameters('AddressSpace')]"
          },
          "deployBastionInOnPrem": {
            "value": "[parameters('deployBastionInOnPrem')]"
          },
          "deployGatewayInOnPrem": {
            "value": "[parameters('deployGatewayinOnPrem')]"
          },
          "deployVMsInOnPrem": {
            "value": "[parameters('deployVMinOnPrem')]"
          },
          "OnPremRgName": {
            "value": "[parameters('onpremRgName')]"
          },
          "vmSize": {
            "value": "[parameters('vmSizeOnPrem')]"
          },
          "tagsByResource": {
            "value": "[parameters('tagsByResource')]"
          },
          "osType": {
            "value": "[parameters('osTypeOnPrem')]"
          },
          "vpnGwBgpAsn": {
            "value": "[if(parameters('onpremBgp'), parameters('onpremBgpAsn'), 65515)]"
          },
          "vpnGwEnebaleBgp": {
            "value": "[parameters('onpremBgp')]"
          },
          "bastionSku": {
            "value": "[parameters('bastionInOnPremSKU')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1272.37030",
              "templateHash": "6790167175835417825"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "AddressSpace": {
              "type": "string"
            },
            "deployBastionInOnPrem": {
              "type": "bool"
            },
            "bastionSku": {
              "type": "string"
            },
            "adminUsername": {
              "type": "string"
            },
            "adminPassword": {
              "type": "secureString"
            },
            "deployVMsInOnPrem": {
              "type": "bool"
            },
            "deployGatewayInOnPrem": {
              "type": "bool"
            },
            "OnPremRgName": {
              "type": "string"
            },
            "vmSize": {
              "type": "string"
            },
            "tagsByResource": {
              "type": "object"
            },
            "osType": {
              "type": "string"
            },
            "vpnGwEnebaleBgp": {
              "type": "bool"
            },
            "vpnGwBgpAsn": {
              "type": "int"
            }
          },
          "variables": {
            "vnetName": "VNET-OnPrem",
            "vmName": "VM-OnPrem",
            "nsgName": "NSG-OnPrem",
            "bastionName": "Bastion-OnPrem",
            "gatewayName": "Gateway-OnPrem",
            "vnetAddressSpace": "[replace(parameters('AddressSpace'), '0.0/16', '255.0/24')]",
            "defaultSubnetPrefix": "[replace(variables('vnetAddressSpace'), '/24', '/26')]",
            "bastionSubnetPrefix": "[replace(variables('vnetAddressSpace'), '0/24', '128/27')]",
            "gatewaySubnetPrefix": "[replace(variables('vnetAddressSpace'), '0/24', '160/27')]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[parameters('OnPremRgName')]",
              "location": "[parameters('location')]",
              "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Resources/subscriptions/resourceGroups'), parameters('tagsByResource')['Microsoft.Resources/subscriptions/resourceGroups'], createObject())]"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('vnetName')]",
              "resourceGroup": "[parameters('OnPremRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "vnetAddressSpcae": {
                    "value": "[variables('vnetAddressSpace')]"
                  },
                  "nsgID": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRgName')), 'Microsoft.Resources/deployments', variables('nsgName'))).outputs.nsgID.value]"
                  },
                  "vnetname": {
                    "value": "[variables('vnetName')]"
                  },
                  "defaultSubnetPrefix": {
                    "value": "[variables('defaultSubnetPrefix')]"
                  },
                  "bastionSubnetPrefix": {
                    "value": "[if(parameters('deployBastionInOnPrem'), variables('bastionSubnetPrefix'), '')]"
                  },
                  "GatewaySubnetPrefix": {
                    "value": "[variables('gatewaySubnetPrefix')]"
                  },
                  "deployBastionSubnet": {
                    "value": "[parameters('deployBastionInOnPrem')]"
                  },
                  "deployGatewaySubnet": {
                    "value": true
                  },
                  "tagsByResource": {
                    "value": "[parameters('tagsByResource')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "15972562488758076476"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "vnetname": {
                      "type": "string"
                    },
                    "vnetAddressSpcae": {
                      "type": "string"
                    },
                    "defaultSubnetPrefix": {
                      "type": "string"
                    },
                    "bastionSubnetPrefix": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "firewallSubnetPrefix": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "GatewaySubnetPrefix": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "nsgID": {
                      "type": "string"
                    },
                    "rtDefID": {
                      "type": "string",
                      "defaultValue": "none"
                    },
                    "rtGwID": {
                      "type": "string",
                      "defaultValue": "none"
                    },
                    "deployBastionSubnet": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "deployFirewallSubnet": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "deployGatewaySubnet": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "variables": {
                    "defaultSubnet": [
                      {
                        "name": "default",
                        "properties": {
                          "addressPrefix": "[parameters('defaultSubnetPrefix')]",
                          "networkSecurityGroup": {
                            "id": "[parameters('nsgID')]"
                          },
                          "routeTable": "[if(equals(parameters('rtDefID'), 'none'), json('null'), json(format('{{\"id\": \"{0}\"}}\"', parameters('rtDefID'))))]"
                        }
                      }
                    ],
                    "bastionSubnet": "[if(not(parameters('deployBastionSubnet')), createArray(), createArray(createObject('name', 'AzureBastionSubnet', 'properties', createObject('addressPrefix', parameters('bastionSubnetPrefix')))))]",
                    "firewallSubnet": "[if(not(parameters('deployFirewallSubnet')), createArray(), createArray(createObject('name', 'AzureFirewallSubnet', 'properties', createObject('addressPrefix', parameters('firewallSubnetPrefix')))))]",
                    "gatewaySubnet": "[if(and(not(parameters('deployGatewaySubnet')), not(parameters('deployFirewallSubnet'))), createArray(), createArray(createObject('name', 'GatewaySubnet', 'properties', createObject('addressPrefix', parameters('GatewaySubnetPrefix'), 'routeTable', if(equals(parameters('rtGwID'), 'none'), json('null'), json(format('{{\"id\": \"{0}\"}}\"', parameters('rtGwID'))))))))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('vnetname')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('vnetAddressSpcae')]"
                          ]
                        },
                        "subnets": "[concat(variables('defaultSubnet'), variables('bastionSubnet'), variables('firewallSubnet'), variables('gatewaySubnet'))]"
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/virtualNetworks'), parameters('tagsByResource')['Microsoft.Network/virtualNetworks'], createObject())]"
                    }
                  ],
                  "outputs": {
                    "vnetName": {
                      "type": "string",
                      "value": "[parameters('vnetname')]"
                    },
                    "vnetID": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetname'))]"
                    },
                    "defaultSubnetID": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetname'))).subnets[0].id]"
                    },
                    "bastionSubnetID": {
                      "type": "string",
                      "value": "[if(parameters('deployBastionSubnet'), resourceId('Microsoft.Network/VirtualNetworks/subnets', parameters('vnetname'), 'AzureBastionSubnet'), 'Not deployed')]"
                    },
                    "firewallSubnetID": {
                      "type": "string",
                      "value": "[if(parameters('deployFirewallSubnet'), resourceId('Microsoft.Network/VirtualNetworks/subnets', parameters('vnetname'), 'AzureFirewallSubnet'), 'Not deployed')]"
                    },
                    "gatewaySubnetID": {
                      "type": "string",
                      "value": "[if(parameters('deployGatewaySubnet'), resourceId('Microsoft.Network/VirtualNetworks/subnets', parameters('vnetname'), 'GatewaySubnet'), 'Not deployed')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRgName')), 'Microsoft.Resources/deployments', variables('nsgName'))]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('OnPremRgName'))]"
              ]
            },
            {
              "condition": "[parameters('deployVMsInOnPrem')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('vmName')]",
              "resourceGroup": "[parameters('OnPremRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "adminPassword": {
                    "value": "[parameters('adminPassword')]"
                  },
                  "adminUsername": {
                    "value": "[parameters('adminUsername')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "subnetID": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRgName')), 'Microsoft.Resources/deployments', variables('vnetName'))).outputs.defaultSubnetID.value]"
                  },
                  "vmName": {
                    "value": "[variables('vmName')]"
                  },
                  "vmSize": {
                    "value": "[parameters('vmSize')]"
                  },
                  "tagsByResource": {
                    "value": "[parameters('tagsByResource')]"
                  },
                  "osType": {
                    "value": "[parameters('osType')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "8734156456072154768"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "vmName": {
                      "type": "string"
                    },
                    "adminUsername": {
                      "type": "string"
                    },
                    "adminPassword": {
                      "type": "secureString"
                    },
                    "subnetID": {
                      "type": "string"
                    },
                    "vmSize": {
                      "type": "string"
                    },
                    "storageType": {
                      "type": "string",
                      "defaultValue": "StandardSSD_LRS"
                    },
                    "osType": {
                      "type": "string",
                      "defaultValue": "Windows"
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "variables": {
                    "EnableICMPv4": "netsh advfirewall firewall add rule name=\"ICMP Allow incoming V4 echo request\" protocol=\"icmpv4:8,any\" dir=in action=allow",
                    "Windows": {
                      "publisher": "MicrosoftWindowsServer",
                      "offer": "WindowsServer",
                      "sku": "2022-datacenter-g2",
                      "version": "latest"
                    },
                    "Linux": {
                      "publisher": "Canonical",
                      "offer": "0001-com-ubuntu-server-jammy",
                      "sku": "22_04-lts-gen2",
                      "version": "latest"
                    },
                    "imagereference": "[if(equals(parameters('osType'), 'Windows'), variables('Windows'), if(equals(parameters('osType'), 'Linux'), variables('Linux'), createObject()))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2021-11-01",
                      "name": "[parameters('vmName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "osProfile": {
                          "computerName": "[parameters('vmName')]",
                          "adminUsername": "[parameters('adminUsername')]",
                          "adminPassword": "[parameters('adminPassword')]"
                        },
                        "storageProfile": {
                          "imageReference": "[variables('imagereference')]",
                          "osDisk": {
                            "createOption": "FromImage",
                            "managedDisk": {
                              "storageAccountType": "[parameters('storageType')]"
                            },
                            "osType": "[parameters('osType')]",
                            "deleteOption": "Delete"
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-nic', parameters('vmName')))]",
                              "properties": {
                                "deleteOption": "Delete"
                              }
                            }
                          ]
                        },
                        "hardwareProfile": {
                          "vmSize": "[parameters('vmSize')]"
                        },
                        "diagnosticsProfile": {
                          "bootDiagnostics": {
                            "enabled": true
                          }
                        }
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Compute/virtualMachines'), parameters('tagsByResource')['Microsoft.Compute/virtualMachines'], createObject())]",
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-nic', parameters('vmName')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}-nic', parameters('vmName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "ipconfig1",
                            "properties": {
                              "primary": true,
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[parameters('subnetID')]"
                              }
                            }
                          }
                        ]
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Compute/virtualMachines'), parameters('tagsByResource')['Microsoft.Compute/virtualMachines'], createObject())]"
                    },
                    {
                      "condition": "[equals(parameters('osType'), 'Windows')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[format('{0}-runCommand', parameters('vmName'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "runCommand": {
                            "value": "[variables('EnableICMPv4')]"
                          },
                          "vmName": {
                            "value": "[parameters('vmName')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.1272.37030",
                              "templateHash": "13065007741233957351"
                            }
                          },
                          "parameters": {
                            "location": {
                              "type": "string"
                            },
                            "vmName": {
                              "type": "string"
                            },
                            "runName": {
                              "type": "string",
                              "defaultValue": "RunCommand"
                            },
                            "runCommand": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Compute/virtualMachines/runCommands",
                              "apiVersion": "2021-11-01",
                              "name": "[format('{0}/{1}', parameters('vmName'), parameters('runName'))]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "source": {
                                  "script": "[parameters('runCommand')]"
                                },
                                "timeoutInSeconds": 60
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('OnPremRgName'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRgName')), 'Microsoft.Resources/deployments', variables('vnetName'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('nsgName')]",
              "resourceGroup": "[parameters('OnPremRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "nsgName": {
                    "value": "[variables('nsgName')]"
                  },
                  "tagsByResource": {
                    "value": "[parameters('tagsByResource')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "4986852817278939313"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "nsgName": {
                      "type": "string"
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('nsgName')]",
                      "location": "[parameters('location')]",
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/networkSecurityGroups'), parameters('tagsByResource')['Microsoft.Network/networkSecurityGroups'], createObject())]"
                    }
                  ],
                  "outputs": {
                    "nsgID": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('OnPremRgName'))]"
              ]
            },
            {
              "condition": "[parameters('deployBastionInOnPrem')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('bastionName')]",
              "resourceGroup": "[parameters('OnPremRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "subnetID": {
                    "value": "[if(parameters('deployBastionInOnPrem'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRgName')), 'Microsoft.Resources/deployments', variables('vnetName'))).outputs.bastionSubnetID.value, '')]"
                  },
                  "bastionName": {
                    "value": "[variables('bastionName')]"
                  },
                  "tagsByResource": {
                    "value": "[parameters('tagsByResource')]"
                  },
                  "bastionSku": {
                    "value": "[parameters('bastionSku')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "5886547612277966671"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "bastionName": {
                      "type": "string"
                    },
                    "subnetID": {
                      "type": "string"
                    },
                    "bastionSku": {
                      "type": "string",
                      "allowedValues": [
                        "Basic",
                        "Standard"
                      ]
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/bastionHosts",
                      "apiVersion": "2021-03-01",
                      "name": "[parameters('bastionName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "IpConf",
                            "properties": {
                              "subnet": {
                                "id": "[parameters('subnetID')]"
                              },
                              "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-pip', parameters('bastionName')))]"
                              }
                            }
                          }
                        ]
                      },
                      "sku": {
                        "name": "[parameters('bastionSku')]"
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/bastionHosts'), parameters('tagsByResource')['Microsoft.Network/bastionHosts'], createObject())]",
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-pip', parameters('bastionName')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}-pip', parameters('bastionName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publicIPAddressVersion": "IPv4",
                        "publicIPAllocationMethod": "Static"
                      },
                      "sku": {
                        "tier": "Regional",
                        "name": "Standard"
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/publicIPAddresses'), parameters('tagsByResource')['Microsoft.Network/publicIPAddresses'], createObject())]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('OnPremRgName'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRgName')), 'Microsoft.Resources/deployments', variables('vnetName'))]"
              ]
            },
            {
              "condition": "[parameters('deployGatewayInOnPrem')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('gatewayName')]",
              "resourceGroup": "[parameters('OnPremRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "vpnGatewayName": {
                    "value": "[variables('gatewayName')]"
                  },
                  "vpnGatewaySubnetID": {
                    "value": "[if(parameters('deployGatewayInOnPrem'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRgName')), 'Microsoft.Resources/deployments', variables('vnetName'))).outputs.gatewaySubnetID.value, '')]"
                  },
                  "tagsByResource": {
                    "value": "[parameters('tagsByResource')]"
                  },
                  "vpnGatewayBgpAsn": {
                    "value": "[if(parameters('vpnGwEnebaleBgp'), parameters('vpnGwBgpAsn'), 65515)]"
                  },
                  "vpnGatewayEnableBgp": {
                    "value": "[parameters('vpnGwEnebaleBgp')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "13332477170440770040"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "vpnGatewayName": {
                      "type": "string"
                    },
                    "vpnGatewaySubnetID": {
                      "type": "string"
                    },
                    "vpnGatewaySKU": {
                      "type": "string",
                      "defaultValue": "VpnGw1"
                    },
                    "vpnGatewayType": {
                      "type": "string",
                      "defaultValue": "Vpn"
                    },
                    "vpnGatewayVPNtype": {
                      "type": "string",
                      "defaultValue": "RouteBased"
                    },
                    "vpnGatewayGen": {
                      "type": "string",
                      "defaultValue": "Generation1"
                    },
                    "vpnGatewayEnableBgp": {
                      "type": "bool"
                    },
                    "vpnGatewayBgpAsn": {
                      "type": "int"
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "variables": {
                    "pipName": "[format('{0}-pip', parameters('vpnGatewayName'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworkGateways",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('vpnGatewayName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "gatewayType": "[parameters('vpnGatewayType')]",
                        "vpnType": "[parameters('vpnGatewayVPNtype')]",
                        "enableBgp": "[parameters('vpnGatewayEnableBgp')]",
                        "bgpSettings": {
                          "asn": "[parameters('vpnGatewayBgpAsn')]"
                        },
                        "sku": {
                          "name": "[parameters('vpnGatewaySKU')]",
                          "tier": "[parameters('vpnGatewaySKU')]"
                        },
                        "vpnGatewayGeneration": "[parameters('vpnGatewayGen')]",
                        "activeActive": false,
                        "ipConfigurations": [
                          {
                            "name": "ipConfig",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[parameters('vpnGatewaySubnetID')]"
                              },
                              "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('pipName'))]"
                              }
                            }
                          }
                        ]
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/virtualNetworkGateways'), parameters('tagsByResource')['Microsoft.Network/virtualNetworkGateways'], createObject())]",
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', variables('pipName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2021-05-01",
                      "name": "[variables('pipName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publicIPAddressVersion": "IPv4",
                        "publicIPAllocationMethod": "Static"
                      },
                      "sku": {
                        "tier": "Regional",
                        "name": "Standard"
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/publicIPAddresses'), parameters('tagsByResource')['Microsoft.Network/publicIPAddresses'], createObject())]"
                    }
                  ],
                  "outputs": {
                    "vpnGwPublicIP": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('pipName'))).ipAddress]"
                    },
                    "vpnGwID": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworkGateways', parameters('vpnGatewayName'))]"
                    },
                    "vpnGwBgpPeeringAddress": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Network/virtualNetworkGateways', parameters('vpnGatewayName'))).bgpSettings.bgpPeeringAddress]"
                    },
                    "vpnGwName": {
                      "type": "string",
                      "value": "[parameters('vpnGatewayName')]"
                    },
                    "vpnGwAsn": {
                      "type": "int",
                      "value": "[reference(resourceId('Microsoft.Network/virtualNetworkGateways', parameters('vpnGatewayName'))).bgpSettings.asn]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('OnPremRgName'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRgName')), 'Microsoft.Resources/deployments', variables('vnetName'))]"
              ]
            }
          ],
          "outputs": {
            "OnPremGatewayPublicIP": {
              "type": "string",
              "value": "[if(parameters('deployGatewayInOnPrem'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRgName')), 'Microsoft.Resources/deployments', variables('gatewayName'))).outputs.vpnGwPublicIP.value, 'none')]"
            },
            "OnPremGatewayID": {
              "type": "string",
              "value": "[if(parameters('deployGatewayInOnPrem'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRgName')), 'Microsoft.Resources/deployments', variables('gatewayName'))).outputs.vpnGwID.value, 'none')]"
            },
            "OnPremAddressSpace": {
              "type": "string",
              "value": "[variables('vnetAddressSpace')]"
            },
            "OnPremGwBgpPeeringAddress": {
              "type": "string",
              "value": "[if(parameters('deployGatewayInOnPrem'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRgName')), 'Microsoft.Resources/deployments', variables('gatewayName'))).outputs.vpnGwBgpPeeringAddress.value, 'none')]"
            },
            "OnPremGwBgpAsn": {
              "type": "int",
              "value": "[if(and(parameters('deployGatewayInOnPrem'), parameters('vpnGwEnebaleBgp')), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRgName')), 'Microsoft.Resources/deployments', variables('gatewayName'))).outputs.vpnGwAsn.value, 0)]"
            }
          }
        }
      }
    },
    {
      "condition": "[and(and(and(parameters('deployGatewayInHub'), parameters('deployGatewayinOnPrem')), parameters('deploySiteToSite')), equals(parameters('hubType'), 'VNET'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-s2s-Hub-OnPrem-{1}', parameters('hubRgName'), parameters('location'))]",
      "subscriptionId": "[parameters('hubSubscriptionID')]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "HubRgName": {
            "value": "[if(and(parameters('deployHUB'), equals(parameters('hubType'), 'VNET')), parameters('hubRgName'), 'none')]"
          },
          "HubGatewayID": {
            "value": "[if(and(parameters('deployGatewayInHub'), equals(parameters('hubType'), 'VNET')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VNET', parameters('hubRgName'), parameters('location')))).outputs.hubGatewayID.value, 'none')]"
          },
          "HubGatewayPublicIP": {
            "value": "[if(and(parameters('deployGatewayInHub'), equals(parameters('hubType'), 'VNET')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VNET', parameters('hubRgName'), parameters('location')))).outputs.hubGatewayPublicIP.value, 'none')]"
          },
          "HubAddressPrefixes": {
            "value": "[if(and(parameters('deployHUB'), equals(parameters('hubType'), 'VNET')), variables('AllAddressSpaces'), createArray())]"
          },
          "HubLocalGatewayName": {
            "value": "[if(and(parameters('deploySiteToSite'), equals(parameters('hubType'), 'VNET')), 'LocalGateway-Hub', 'none')]"
          },
          "OnPremRgName": {
            "value": "[if(and(parameters('deployOnPrem'), equals(parameters('hubType'), 'VNET')), parameters('onpremRgName'), 'none')]"
          },
          "OnPremGatewayID": {
            "value": "[if(and(parameters('deployGatewayinOnPrem'), equals(parameters('hubType'), 'VNET')), reference(subscriptionResourceId(parameters('onPremSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}', parameters('onpremRgName'), parameters('location')))).outputs.OnPremGatewayID.value, 'none')]"
          },
          "OnPremGatewayPublicIP": {
            "value": "[if(and(parameters('deployGatewayinOnPrem'), equals(parameters('hubType'), 'VNET')), reference(subscriptionResourceId(parameters('onPremSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}', parameters('onpremRgName'), parameters('location')))).outputs.OnPremGatewayPublicIP.value, 'none')]"
          },
          "OnPremAddressPrefixes": {
            "value": "[if(and(parameters('deployOnPrem'), equals(parameters('hubType'), 'VNET')), array(reference(subscriptionResourceId(parameters('onPremSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}', parameters('onpremRgName'), parameters('location')))).outputs.OnPremAddressSpace.value), createArray())]"
          },
          "OnPremLocalGatewayName": {
            "value": "[if(and(parameters('deploySiteToSite'), equals(parameters('hubType'), 'VNET')), 'LocalGateway-OnPrem', 'none')]"
          },
          "tagsByResource": {
            "value": "[parameters('tagsByResource')]"
          },
          "enableBgp": {
            "value": "[and(parameters('hubBgp'), parameters('onpremBgp'))]"
          },
          "HubBgpAsn": {
            "value": "[parameters('hubBgpAsn')]"
          },
          "HubBgpPeeringAddress": {
            "value": "[if(and(and(parameters('deployGatewayInHub'), parameters('hubBgp')), equals(parameters('hubType'), 'VNET')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VNET', parameters('hubRgName'), parameters('location')))).outputs.HubGwBgpPeeringAddress.value, 'none')]"
          },
          "OnPremBgpAsn": {
            "value": "[parameters('onpremBgpAsn')]"
          },
          "OnPremBgpPeeringAddress": {
            "value": "[if(and(and(parameters('deployGatewayinOnPrem'), parameters('onpremBgp')), equals(parameters('hubType'), 'VNET')), reference(subscriptionResourceId(parameters('onPremSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}', parameters('onpremRgName'), parameters('location')))).outputs.OnPremGwBgpPeeringAddress.value, 'none')]"
          },
          "sharedKey": {
            "value": "[if(parameters('deploySiteToSite'), parameters('sharedKey'), 'none')]"
          },
          "hubSubscriptionID": {
            "value": "[parameters('hubSubscriptionID')]"
          },
          "onPremSubscriptionID": {
            "value": "[parameters('onPremSubscriptionID')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1272.37030",
              "templateHash": "7714192563091238242"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "sharedKey": {
              "type": "secureString"
            },
            "enableBgp": {
              "type": "bool"
            },
            "tagsByResource": {
              "type": "object"
            },
            "OnPremGatewayID": {
              "type": "string"
            },
            "OnPremRgName": {
              "type": "string"
            },
            "OnPremBgpAsn": {
              "type": "int"
            },
            "OnPremBgpPeeringAddress": {
              "type": "string"
            },
            "HubGatewayPublicIP": {
              "type": "string"
            },
            "HubLocalGatewayName": {
              "type": "string"
            },
            "HubAddressPrefixes": {
              "type": "array"
            },
            "HubGatewayID": {
              "type": "string"
            },
            "HubRgName": {
              "type": "string"
            },
            "HubBgpAsn": {
              "type": "int"
            },
            "HubBgpPeeringAddress": {
              "type": "string"
            },
            "OnPremGatewayPublicIP": {
              "type": "string"
            },
            "OnPremLocalGatewayName": {
              "type": "string"
            },
            "OnPremAddressPrefixes": {
              "type": "array"
            },
            "hubSubscriptionID": {
              "type": "string"
            },
            "onPremSubscriptionID": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[parameters('HubLocalGatewayName')]",
              "subscriptionId": "[parameters('onPremSubscriptionID')]",
              "resourceGroup": "[parameters('OnPremRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "LocalGatewayAddressPrefixes": {
                    "value": "[parameters('HubAddressPrefixes')]"
                  },
                  "LocalGatewayName": {
                    "value": "[parameters('HubLocalGatewayName')]"
                  },
                  "LocalGatewayPublicIP": {
                    "value": "[parameters('HubGatewayPublicIP')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "connectionName": {
                    "value": "VPNtoHub"
                  },
                  "sharedKey": {
                    "value": "[parameters('sharedKey')]"
                  },
                  "VpnGatewayID": {
                    "value": "[parameters('OnPremGatewayID')]"
                  },
                  "tagsByResource": {
                    "value": "[parameters('tagsByResource')]"
                  },
                  "enableBgp": {
                    "value": "[parameters('enableBgp')]"
                  },
                  "BgpAsn": {
                    "value": "[parameters('HubBgpAsn')]"
                  },
                  "BgpPeeringAddress": {
                    "value": "[parameters('HubBgpPeeringAddress')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "43870093113975152"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "LocalGatewayName": {
                      "type": "string"
                    },
                    "LocalGatewayPublicIP": {
                      "type": "string"
                    },
                    "LocalGatewayAddressPrefixes": {
                      "type": "array"
                    },
                    "VpnGatewayID": {
                      "type": "string"
                    },
                    "connectionName": {
                      "type": "string"
                    },
                    "sharedKey": {
                      "type": "secureString"
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "enableBgp": {
                      "type": "bool"
                    },
                    "BgpAsn": {
                      "type": "int"
                    },
                    "BgpPeeringAddress": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/localNetworkGateways",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('LocalGatewayName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "gatewayIpAddress": "[parameters('LocalGatewayPublicIP')]",
                        "bgpSettings": "[if(parameters('enableBgp'), createObject('asn', parameters('BgpAsn'), 'bgpPeeringAddress', parameters('BgpPeeringAddress')), null())]",
                        "localNetworkAddressSpace": "[if(parameters('enableBgp'), createObject(), createObject('addressPrefixes', parameters('LocalGatewayAddressPrefixes')))]"
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/localNetworkGateways'), parameters('tagsByResource')['Microsoft.Network/localNetworkGateways'], createObject())]"
                    },
                    {
                      "type": "Microsoft.Network/connections",
                      "apiVersion": "2020-07-01",
                      "name": "[parameters('connectionName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "connectionType": "IPsec",
                        "connectionMode": "Default",
                        "connectionProtocol": "IKEv2",
                        "useLocalAzureIpAddress": false,
                        "usePolicyBasedTrafficSelectors": false,
                        "enableBgp": "[parameters('enableBgp')]",
                        "sharedKey": "[parameters('sharedKey')]",
                        "virtualNetworkGateway1": {
                          "id": "[parameters('VpnGatewayID')]",
                          "properties": {}
                        },
                        "localNetworkGateway2": {
                          "id": "[resourceId('Microsoft.Network/localNetworkGateways', parameters('LocalGatewayName'))]",
                          "properties": {}
                        }
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/connections'), parameters('tagsByResource')['Microsoft.Network/connections'], createObject())]",
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/localNetworkGateways', parameters('LocalGatewayName'))]"
                      ]
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[parameters('OnPremLocalGatewayName')]",
              "subscriptionId": "[parameters('hubSubscriptionID')]",
              "resourceGroup": "[parameters('HubRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "LocalGatewayAddressPrefixes": {
                    "value": "[parameters('OnPremAddressPrefixes')]"
                  },
                  "LocalGatewayName": {
                    "value": "[parameters('OnPremLocalGatewayName')]"
                  },
                  "LocalGatewayPublicIP": {
                    "value": "[parameters('OnPremGatewayPublicIP')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "connectionName": {
                    "value": "VPNtoOnPrem"
                  },
                  "sharedKey": {
                    "value": "[parameters('sharedKey')]"
                  },
                  "VpnGatewayID": {
                    "value": "[parameters('HubGatewayID')]"
                  },
                  "tagsByResource": {
                    "value": "[parameters('tagsByResource')]"
                  },
                  "enableBgp": {
                    "value": "[parameters('enableBgp')]"
                  },
                  "BgpAsn": {
                    "value": "[parameters('OnPremBgpAsn')]"
                  },
                  "BgpPeeringAddress": {
                    "value": "[parameters('OnPremBgpPeeringAddress')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "43870093113975152"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "LocalGatewayName": {
                      "type": "string"
                    },
                    "LocalGatewayPublicIP": {
                      "type": "string"
                    },
                    "LocalGatewayAddressPrefixes": {
                      "type": "array"
                    },
                    "VpnGatewayID": {
                      "type": "string"
                    },
                    "connectionName": {
                      "type": "string"
                    },
                    "sharedKey": {
                      "type": "secureString"
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "enableBgp": {
                      "type": "bool"
                    },
                    "BgpAsn": {
                      "type": "int"
                    },
                    "BgpPeeringAddress": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/localNetworkGateways",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('LocalGatewayName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "gatewayIpAddress": "[parameters('LocalGatewayPublicIP')]",
                        "bgpSettings": "[if(parameters('enableBgp'), createObject('asn', parameters('BgpAsn'), 'bgpPeeringAddress', parameters('BgpPeeringAddress')), null())]",
                        "localNetworkAddressSpace": "[if(parameters('enableBgp'), createObject(), createObject('addressPrefixes', parameters('LocalGatewayAddressPrefixes')))]"
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/localNetworkGateways'), parameters('tagsByResource')['Microsoft.Network/localNetworkGateways'], createObject())]"
                    },
                    {
                      "type": "Microsoft.Network/connections",
                      "apiVersion": "2020-07-01",
                      "name": "[parameters('connectionName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "connectionType": "IPsec",
                        "connectionMode": "Default",
                        "connectionProtocol": "IKEv2",
                        "useLocalAzureIpAddress": false,
                        "usePolicyBasedTrafficSelectors": false,
                        "enableBgp": "[parameters('enableBgp')]",
                        "sharedKey": "[parameters('sharedKey')]",
                        "virtualNetworkGateway1": {
                          "id": "[parameters('VpnGatewayID')]",
                          "properties": {}
                        },
                        "localNetworkGateway2": {
                          "id": "[resourceId('Microsoft.Network/localNetworkGateways', parameters('LocalGatewayName'))]",
                          "properties": {}
                        }
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/connections'), parameters('tagsByResource')['Microsoft.Network/connections'], createObject())]",
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/localNetworkGateways', parameters('LocalGatewayName'))]"
                      ]
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VNET', parameters('hubRgName'), parameters('location')))]",
        "[subscriptionResourceId(parameters('onPremSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}', parameters('onpremRgName'), parameters('location')))]"
      ]
    },
    {
      "condition": "[and(and(and(parameters('deployGatewayInHub'), parameters('deployGatewayinOnPrem')), parameters('deploySiteToSite')), equals(parameters('hubType'), 'VWAN'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-s2s-Hub-vWan-OnPrem-{1}', parameters('hubRgName'), parameters('location'))]",
      "subscriptionId": "[parameters('hubSubscriptionID')]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "vwanGatewayName": {
            "value": "[if(and(and(parameters('deployHUB'), parameters('deployGatewayInHub')), equals(parameters('hubType'), 'VWAN')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VWAN', parameters('hubRgName'), parameters('location')))).outputs.vpnGwName.value, 'none')]"
          },
          "vwanLinkBgpAsn": {
            "value": "[if(and(and(parameters('deployOnPrem'), parameters('deployGatewayinOnPrem')), parameters('onpremBgp')), reference(subscriptionResourceId(parameters('onPremSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}', parameters('onpremRgName'), parameters('location')))).outputs.OnPremGwBgpAsn.value, 65515)]"
          },
          "vwanLinkPublicIP": {
            "value": "[if(and(parameters('deployOnPrem'), parameters('deployGatewayinOnPrem')), reference(subscriptionResourceId(parameters('onPremSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}', parameters('onpremRgName'), parameters('location')))).outputs.OnPremGatewayPublicIP.value, 'none')]"
          },
          "vwanVpnGwInfo": {
            "value": "[if(and(and(parameters('deployHUB'), parameters('deployGatewayInHub')), equals(parameters('hubType'), 'VWAN')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VWAN', parameters('hubRgName'), parameters('location')))).outputs.vpnGwBgpIp.value, createArray())]"
          },
          "vwanLinkBgpPeeringAddress": {
            "value": "[if(and(and(and(parameters('deployOnPrem'), parameters('deployGatewayinOnPrem')), parameters('onpremBgp')), equals(parameters('hubType'), 'VWAN')), reference(subscriptionResourceId(parameters('onPremSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}', parameters('onpremRgName'), parameters('location')))).outputs.OnPremGwBgpPeeringAddress.value, 'none')]"
          },
          "vwanVpnSiteName": {
            "value": "OnPrem"
          },
          "vwanID": {
            "value": "[if(and(parameters('deployHUB'), equals(parameters('hubType'), 'VWAN')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VWAN', parameters('hubRgName'), parameters('location')))).outputs.vWanID.value, 'none')]"
          },
          "vwanHubName": {
            "value": "[if(and(parameters('deployHUB'), equals(parameters('hubType'), 'VWAN')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VWAN', parameters('hubRgName'), parameters('location')))).outputs.vwanHubName.value, 'none')]"
          },
          "OnPremVpnGwID": {
            "value": "[if(and(parameters('deployOnPrem'), parameters('deployGatewayinOnPrem')), reference(subscriptionResourceId(parameters('onPremSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}', parameters('onpremRgName'), parameters('location')))).outputs.OnPremGatewayID.value, 'none')]"
          },
          "OnPremRgName": {
            "value": "[if(parameters('deployOnPrem'), parameters('onpremRgName'), 'none')]"
          },
          "HubRgName": {
            "value": "[if(parameters('deployHUB'), parameters('hubRgName'), 'none')]"
          },
          "tagsByResource": {
            "value": "[parameters('tagsByResource')]"
          },
          "deployFirewallInHub": {
            "value": "[and(parameters('deployFirewallInHub'), equals(parameters('hubType'), 'VWAN'))]"
          },
          "sharedKey": {
            "value": "[if(parameters('deploySiteToSite'), parameters('sharedKey'), 'none')]"
          },
          "hubSubscriptionID": {
            "value": "[parameters('hubSubscriptionID')]"
          },
          "onPremSubscriptionID": {
            "value": "[parameters('onPremSubscriptionID')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1272.37030",
              "templateHash": "7180343005180312277"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "sharedKey": {
              "type": "secureString"
            },
            "OnPremRgName": {
              "type": "string"
            },
            "HubRgName": {
              "type": "string"
            },
            "vwanLinkBgpAsn": {
              "type": "int"
            },
            "vwanLinkBgpPeeringAddress": {
              "type": "string"
            },
            "vwanLinkPublicIP": {
              "type": "string"
            },
            "vwanVpnSiteName": {
              "type": "string"
            },
            "vwanID": {
              "type": "string"
            },
            "vwanHubName": {
              "type": "string"
            },
            "vwanGatewayName": {
              "type": "string"
            },
            "vwanVpnGwInfo": {
              "type": "array"
            },
            "tagsByResource": {
              "type": "object",
              "defaultValue": {}
            },
            "deployFirewallInHub": {
              "type": "bool"
            },
            "OnPremVpnGwID": {
              "type": "string"
            },
            "hubSubscriptionID": {
              "type": "string"
            },
            "onPremSubscriptionID": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "vwanVPNsites",
              "subscriptionId": "[parameters('hubSubscriptionID')]",
              "resourceGroup": "[parameters('HubRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "linkBgpAsn": {
                    "value": "[parameters('vwanLinkBgpAsn')]"
                  },
                  "linkBgpPeeringAddress": {
                    "value": "[parameters('vwanLinkBgpPeeringAddress')]"
                  },
                  "linkPublicIP": {
                    "value": "[parameters('vwanLinkPublicIP')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "vpnSiteName": {
                    "value": "[parameters('vwanVpnSiteName')]"
                  },
                  "vwanGatewayName": {
                    "value": "[parameters('vwanGatewayName')]"
                  },
                  "vwanHubName": {
                    "value": "[parameters('vwanHubName')]"
                  },
                  "vwanID": {
                    "value": "[parameters('vwanID')]"
                  },
                  "sharedKey": {
                    "value": "[parameters('sharedKey')]"
                  },
                  "tagsByResource": {
                    "value": "[parameters('tagsByResource')]"
                  },
                  "propagateToNoneRouteTable": {
                    "value": "[parameters('deployFirewallInHub')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "16762129572348436787"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "linkBgpAsn": {
                      "type": "int"
                    },
                    "linkBgpPeeringAddress": {
                      "type": "string"
                    },
                    "linkPublicIP": {
                      "type": "string"
                    },
                    "vpnSiteName": {
                      "type": "string"
                    },
                    "vwanID": {
                      "type": "string"
                    },
                    "vwanHubName": {
                      "type": "string"
                    },
                    "vwanGatewayName": {
                      "type": "string"
                    },
                    "sharedKey": {
                      "type": "secureString"
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "propagateToNoneRouteTable": {
                      "type": "bool"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/vpnSites",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('vpnSiteName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "deviceProperties": {
                          "deviceModel": "LabBuilder",
                          "deviceVendor": "LabBuilder",
                          "linkSpeedInMbps": 1000
                        },
                        "addressSpace": {},
                        "vpnSiteLinks": [
                          {
                            "name": "[format('{0}-Link', parameters('vpnSiteName'))]",
                            "properties": {
                              "linkProperties": {
                                "linkProviderName": "Azure",
                                "linkSpeedInMbps": 1000
                              },
                              "ipAddress": "[parameters('linkPublicIP')]",
                              "bgpProperties": {
                                "asn": "[parameters('linkBgpAsn')]",
                                "bgpPeeringAddress": "[parameters('linkBgpPeeringAddress')]"
                              }
                            }
                          }
                        ],
                        "virtualWan": {
                          "id": "[parameters('vwanID')]"
                        }
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/vpnSites'), parameters('tagsByResource')['Microsoft.Network/vpnSites'], createObject())]"
                    },
                    {
                      "type": "Microsoft.Network/vpnGateways/vpnConnections",
                      "apiVersion": "2021-05-01",
                      "name": "[format('{0}/Connection-{1}', parameters('vwanGatewayName'), parameters('vpnSiteName'))]",
                      "properties": {
                        "remoteVpnSite": {
                          "id": "[resourceId('Microsoft.Network/vpnSites', parameters('vpnSiteName'))]"
                        },
                        "routingConfiguration": {
                          "associatedRouteTable": {
                            "id": "[resourceId('Microsoft.Network/virtualHubs/hubRouteTables', parameters('vwanHubName'), 'defaultRouteTable')]"
                          },
                          "propagatedRouteTables": {
                            "ids": [
                              {
                                "id": "[resourceId('Microsoft.Network/virtualHubs/hubRouteTables', parameters('vwanHubName'), if(parameters('propagateToNoneRouteTable'), 'noneRouteTable', 'defaultRouteTable'))]"
                              }
                            ],
                            "labels": [
                              "[if(parameters('propagateToNoneRouteTable'), '', 'default')]"
                            ]
                          },
                          "vnetRoutes": {
                            "staticRoutes": []
                          }
                        },
                        "vpnLinkConnections": [
                          {
                            "name": "[format('{0}-Link', parameters('vpnSiteName'))]",
                            "properties": {
                              "vpnSiteLink": {
                                "id": "[reference(resourceId('Microsoft.Network/vpnSites', parameters('vpnSiteName'))).vpnSiteLinks[0].id]"
                              },
                              "enableBgp": true,
                              "vpnConnectionProtocolType": "IKEv2",
                              "sharedKey": "[parameters('sharedKey')]",
                              "ipsecPolicies": [],
                              "enableRateLimiting": false,
                              "useLocalAzureIpAddress": false,
                              "usePolicyBasedTrafficSelectors": false,
                              "vpnLinkConnectionMode": "Default"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/vpnSites', parameters('vpnSiteName'))]"
                      ]
                    }
                  ]
                }
              }
            },
            {
              "copy": {
                "name": "vpnOnPrem",
                "count": "[length(parameters('vwanVpnGwInfo'))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('vpnconnection{0}', add(copyIndex(), 1))]",
              "subscriptionId": "[parameters('onPremSubscriptionID')]",
              "resourceGroup": "[parameters('OnPremRgName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "connectionName": {
                    "value": "[format('toVWAN{0}', add(copyIndex(), 1))]"
                  },
                  "enableBgp": {
                    "value": true
                  },
                  "LocalGatewayAddressPrefixes": {
                    "value": []
                  },
                  "LocalGatewayName": {
                    "value": "[format('VWAN{0}', add(copyIndex(), 1))]"
                  },
                  "BgpPeeringAddress": {
                    "value": "[parameters('vwanVpnGwInfo')[copyIndex()].defaultBgpIpAddresses[0]]"
                  },
                  "BgpAsn": {
                    "value": 65515
                  },
                  "LocalGatewayPublicIP": {
                    "value": "[parameters('vwanVpnGwInfo')[copyIndex()].tunnelIpAddresses[0]]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "sharedKey": {
                    "value": "[parameters('sharedKey')]"
                  },
                  "VpnGatewayID": {
                    "value": "[parameters('OnPremVpnGwID')]"
                  },
                  "tagsByResource": {
                    "value": "[parameters('tagsByResource')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "43870093113975152"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "LocalGatewayName": {
                      "type": "string"
                    },
                    "LocalGatewayPublicIP": {
                      "type": "string"
                    },
                    "LocalGatewayAddressPrefixes": {
                      "type": "array"
                    },
                    "VpnGatewayID": {
                      "type": "string"
                    },
                    "connectionName": {
                      "type": "string"
                    },
                    "sharedKey": {
                      "type": "secureString"
                    },
                    "tagsByResource": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "enableBgp": {
                      "type": "bool"
                    },
                    "BgpAsn": {
                      "type": "int"
                    },
                    "BgpPeeringAddress": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/localNetworkGateways",
                      "apiVersion": "2021-05-01",
                      "name": "[parameters('LocalGatewayName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "gatewayIpAddress": "[parameters('LocalGatewayPublicIP')]",
                        "bgpSettings": "[if(parameters('enableBgp'), createObject('asn', parameters('BgpAsn'), 'bgpPeeringAddress', parameters('BgpPeeringAddress')), null())]",
                        "localNetworkAddressSpace": "[if(parameters('enableBgp'), createObject(), createObject('addressPrefixes', parameters('LocalGatewayAddressPrefixes')))]"
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/localNetworkGateways'), parameters('tagsByResource')['Microsoft.Network/localNetworkGateways'], createObject())]"
                    },
                    {
                      "type": "Microsoft.Network/connections",
                      "apiVersion": "2020-07-01",
                      "name": "[parameters('connectionName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "connectionType": "IPsec",
                        "connectionMode": "Default",
                        "connectionProtocol": "IKEv2",
                        "useLocalAzureIpAddress": false,
                        "usePolicyBasedTrafficSelectors": false,
                        "enableBgp": "[parameters('enableBgp')]",
                        "sharedKey": "[parameters('sharedKey')]",
                        "virtualNetworkGateway1": {
                          "id": "[parameters('VpnGatewayID')]",
                          "properties": {}
                        },
                        "localNetworkGateway2": {
                          "id": "[resourceId('Microsoft.Network/localNetworkGateways', parameters('LocalGatewayName'))]",
                          "properties": {}
                        }
                      },
                      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Network/connections'), parameters('tagsByResource')['Microsoft.Network/connections'], createObject())]",
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/localNetworkGateways', parameters('LocalGatewayName'))]"
                      ]
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId(parameters('onPremSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}', parameters('onpremRgName'), parameters('location')))]",
        "[subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VWAN', parameters('hubRgName'), parameters('location')))]"
      ]
    }
  ],
  "outputs": {
    "VNET_AzFwPrivateIp": {
      "type": "string",
      "value": "[if(and(and(parameters('deployFirewallInHub'), parameters('deployHUB')), equals(parameters('hubType'), 'VNET')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VNET', parameters('hubRgName'), parameters('location')))).outputs.azFwIp.value, 'none')]"
    },
    "VWAN_AzFwPublicIp": {
      "type": "array",
      "value": "[if(and(and(parameters('deployFirewallInHub'), parameters('deployHUB')), equals(parameters('hubType'), 'VWAN')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VWAN', parameters('hubRgName'), parameters('location')))).outputs.vWanFwPublicIP.value, createArray())]"
    },
    "HubVnetID": {
      "type": "string",
      "value": "[if(and(parameters('deployHUB'), equals(parameters('hubType'), 'VNET')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VNET', parameters('hubRgName'), parameters('location')))).outputs.hubVnetID.value, 'none')]"
    },
    "HubVnetAddressSpace": {
      "type": "string",
      "value": "[if(and(parameters('deployHUB'), equals(parameters('hubType'), 'VNET')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VNET', parameters('hubRgName'), parameters('location')))).outputs.hubVnetAddressSpace.value, 'none')]"
    },
    "HubGatewayPublicIP": {
      "type": "string",
      "value": "[if(and(parameters('deployGatewayInHub'), equals(parameters('hubType'), 'VNET')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VNET', parameters('hubRgName'), parameters('location')))).outputs.hubGatewayPublicIP.value, 'none')]"
    },
    "HubGatewayID": {
      "type": "string",
      "value": "[if(and(parameters('deployGatewayInHub'), equals(parameters('hubType'), 'VNET')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VNET', parameters('hubRgName'), parameters('location')))).outputs.hubGatewayID.value, 'none')]"
    },
    "HubBgpPeeringAddress": {
      "type": "string",
      "value": "[if(and(parameters('deployGatewayInHub'), equals(parameters('hubType'), 'VNET')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VNET', parameters('hubRgName'), parameters('location')))).outputs.HubGwBgpPeeringAddress.value, 'none')]"
    },
    "vWanHubID": {
      "type": "string",
      "value": "[if(and(parameters('deployHUB'), equals(parameters('hubType'), 'VWAN')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VWAN', parameters('hubRgName'), parameters('location')))).outputs.vWanHubID.value, 'none')]"
    },
    "vWanID": {
      "type": "string",
      "value": "[if(and(parameters('deployHUB'), equals(parameters('hubType'), 'VWAN')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VWAN', parameters('hubRgName'), parameters('location')))).outputs.vWanID.value, 'none')]"
    },
    "vWanVpnGwID": {
      "type": "string",
      "value": "[if(and(and(parameters('deployHUB'), parameters('deployGatewayInHub')), equals(parameters('hubType'), 'VWAN')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VWAN', parameters('hubRgName'), parameters('location')))).outputs.vWanVpnGwID.value, 'none')]"
    },
    "vWanVpnGwPip": {
      "type": "array",
      "value": "[if(and(and(parameters('deployHUB'), parameters('deployGatewayInHub')), equals(parameters('hubType'), 'VWAN')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VWAN', parameters('hubRgName'), parameters('location')))).outputs.vWanVpnGwPip.value, createArray())]"
    },
    "vWanVpnBgpIp": {
      "type": "array",
      "value": "[if(and(and(parameters('deployHUB'), parameters('deployGatewayInHub')), equals(parameters('hubType'), 'VWAN')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VWAN', parameters('hubRgName'), parameters('location')))).outputs.vpnGwBgpIp.value, createArray())]"
    },
    "vWanVpnBgpAsn": {
      "type": "int",
      "value": "[if(and(and(parameters('deployHUB'), parameters('deployGatewayInHub')), equals(parameters('hubType'), 'VWAN')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VWAN', parameters('hubRgName'), parameters('location')))).outputs.vpnGwBgpAsn.value, 0)]"
    },
    "vWanHubAddressSpace": {
      "type": "string",
      "value": "[if(and(parameters('deployHUB'), equals(parameters('hubType'), 'VWAN')), reference(subscriptionResourceId(parameters('hubSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}-VWAN', parameters('hubRgName'), parameters('location')))).outputs.vWanHubAddressSpace.value, 'none')]"
    },
    "OnPremVnetAddressSpace": {
      "type": "string",
      "value": "[if(parameters('deployOnPrem'), reference(subscriptionResourceId(parameters('onPremSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}', parameters('onpremRgName'), parameters('location')))).outputs.OnPremAddressSpace.value, 'none')]"
    },
    "OnPremGatewayPublicIP": {
      "type": "string",
      "value": "[if(parameters('deployGatewayinOnPrem'), reference(subscriptionResourceId(parameters('onPremSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}', parameters('onpremRgName'), parameters('location')))).outputs.OnPremGatewayPublicIP.value, 'none')]"
    },
    "OnPremGatewayID": {
      "type": "string",
      "value": "[if(parameters('deployGatewayinOnPrem'), reference(subscriptionResourceId(parameters('onPremSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}', parameters('onpremRgName'), parameters('location')))).outputs.OnPremGatewayID.value, 'none')]"
    },
    "OnPremBgpPeeringAddress": {
      "type": "string",
      "value": "[if(parameters('deployGatewayinOnPrem'), reference(subscriptionResourceId(parameters('onPremSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}-{1}', parameters('onpremRgName'), parameters('location')))).outputs.OnPremGwBgpPeeringAddress.value, 'none')]"
    },
    "SpokeVnets": {
      "type": "array",
      "copy": {
        "count": "[length(range(0, parameters('amountOfSpokes')))]",
        "input": "[if(parameters('deploySpokes'), createObject('SpokeVnetId', reference(subscriptionResourceId(parameters('spokeSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}{1}-{2}', parameters('spokeRgNamePrefix'), range(1, parameters('amountOfSpokes'))[range(0, parameters('amountOfSpokes'))[copyIndex()]], parameters('location')))).outputs.spokeVnetID.value, 'SpokeVnetAddressSpace', reference(subscriptionResourceId(parameters('spokeSubscriptionID'), 'Microsoft.Resources/deployments', format('{0}{1}-{2}', parameters('spokeRgNamePrefix'), range(1, parameters('amountOfSpokes'))[range(0, parameters('amountOfSpokes'))[copyIndex()]], parameters('location')))).outputs.spokeVnetAddressSpace.value), 'none')]"
      }
    }
  }
}